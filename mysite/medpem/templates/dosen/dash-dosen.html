{% extends "dosen/base.html" %}
{% load static %}

{% block title %}Dashboard Dosen â€” Citra Digital{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.hero {
  background: linear-gradient(135deg, #eff6ff, #eef2ff);
  padding: 28px;
  border-radius: 18px;
  margin-bottom: 28px;
}

.hero .title {
  font-size: 34px;
  font-weight: 800;
}

.stat-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 22px;
  border: 1px solid #e5e7eb;
  transition: transform 0.2s;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.stat-card .value {
  font-size: 30px;
  font-weight: 800;
  color: #1e293b;
}

.stat-card .label {
  color: #64748b;
  font-size: 15px;
}

.card-section {
  background: #ffffff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  padding: 22px;
  margin-bottom: 26px;
}

.progress-list li {
  padding: 14px 0;
  border-bottom: 1px dashed #e5e7eb;
}

.progress-list li:last-child {
  border-bottom: none;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
  margin-bottom: 6px;
}

.progress-bar-wrapper {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #22c55e, #16a34a);
  border-radius: 999px;
}

.kkm-card {
  max-width: 420px;
}
</style>

<div class="hero">
  <span class="badge bg-primary-subtle text-primary mb-2">
    Dashboard Pengajar
  </span>
  <h1 class="title mt-2">
    Dashboard <span class="text-primary">Dosen</span>
  </h1>
  <p class="text-muted mb-0">
    Ringkasan pengelolaan kelas dan evaluasi pembelajaran 
    <strong>Pengolahan Citra Digital</strong>.
  </p>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="value">{{ total_mhs|default:0 }}</div>
      <div class="label">Total Mahasiswa</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="value">{{ mhs_selesai|default:0 }}</div>
      <div class="label">Mahasiswa Selesai</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="value">{{ total_kelas|default:0 }}</div>
      <div class="label">Kelas Aktif</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="value">{{ mhs_dibawah_kkm|default:0 }}</div>
      <div class="label">Mahasiswa < KKM</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-7">
    <div class="card-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <strong class="d-block">Progres Terbanyak (5 Mahasiswa)</strong>
          <small class="text-muted">Berdasarkan penyelesaian aktivitas kuis dan evaluasi.</small>
        </div>
        
        <form method="GET" id="filterForm">
          <select name="kelas_id" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Semua Kelas</option>
            {% for k in daftar_kelas %}
            <option value="{{ k.id }}" {% if request.GET.kelas_id == k.id|stringformat:"s" %}selected{% endif %}>
              {{ k.nama_kelas }}
            </option>
            {% endfor %}
          </select>
        </form>
      </div>

      <ul class="list-unstyled progress-list">
        {% for mhs in top_mahasiswa %}
        <li>
          <div class="progress-header">
            <span>{{ mhs.display_name }}</span> 
            <span>{{ mhs.progres_persen }}%</span>
          </div>
          <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" style="width:{{ mhs.progres_persen }}%"></div>
          </div>
          <small class="text-muted" style="font-size: 11px;">{{ mhs.kelas.nama_kelas }}</small>
        </li>
        {% empty %}
        <li class="text-muted text-center py-4">Belum ada data mahasiswa</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card-section kkm-card">
      <strong>Pengaturan Nilai KKM (Global)</strong>
      <p class="text-muted mb-3">
        Nilai minimum kelulusan kuis dan evaluasi secara global.
      </p>

      <form method="POST">
        {% csrf_token %}
        <div class="d-flex gap-2 align-items-center">
          <input type="number" 
                 name="kkm" 
                 value="{{ kkm|default:70 }}" 
                 class="form-control" 
                 min="0" max="100"
                 style="max-width:140px;"
                 required>
          <button type="submit" name="update_kkm" class="btn btn-success">
            Simpan KKM
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
{% if messages %}
  {% for message in messages %}
    Swal.fire({
      icon: 'success',
      title: 'Berhasil!',
      text: '{{ message|safe }}',
      confirmButtonColor: '#2563eb',
      timer: 3000,
      showConfirmButton: false
    });
  {% endfor %}
{% endif %}
</script>

{% endblock %}