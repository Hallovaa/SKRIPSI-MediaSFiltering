{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Subbab 5 - Kuis</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{% static 'assets/css/bootstrap-5.0.0-beta1.min.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="{% static 'assets/img/icon/favvvv.png' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #f8fafc;
        margin: 0;
        padding: 0;
    }

    .quiz-wrapper {
        max-width: 1200px;
        margin: 50px auto;
        padding: 0 20px;
    }

    .petunjuk-box {
        max-width: 700px;
        margin: auto;
        background: #fff;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, .08);
    }

    .quiz-layout {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 24px;
        align-items: start;
        position: relative;
    }

    .question-card {
        background: #fff;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, .06);
        min-height: 400px;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .timer {
        color: #ef4444;
        font-weight: 700;
    }

    .option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .option:hover {
        border-color: #2563eb;
        background: #f1f5ff;
    }

    .option.selected {
        border-color: #2563eb;
        background: #eff6ff;
        box-shadow: 0 0 0 1px #2563eb;
    }

    .option.ragu-selected {
        border-color: #fbbf24;
        background: #fffbeb;
        box-shadow: 0 0 0 1px #fbbf24;
    }

    .option::before {
        content: attr(data-label);
        width: 30px;
        height: 30px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        color: #475569;
        flex-shrink: 0;
    }

    .img-option {
        max-height: 80px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .nav-btn {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        gap: 10px;
    }

    .btn-nav-prev {
        background-color: #64748b;
        color: white;
        border: none;
    }

    .btn-nav-prev:hover {
        background-color: #475569;
        color: white;
    }

    .btn-nav-prev:disabled {
        background-color: #cbd5e1;
        cursor: not-allowed;
    }

    .btn-nav-next {
        background-color: #2563eb;
        color: white;
        border: none;
    }

    .btn-nav-next:hover {
        background-color: #1d4ed8;
        color: white;
    }

    .quiz-sidebar {
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, .06);
        position: sticky;
        top: 20px;
    }

    .number-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }

    .number-grid button {
        height: 38px;
        border-radius: 8px;
        border: none;
        background: #e5e7eb;
        font-weight: 600;
        transition: 0.2s;
    }

    .number-grid .done {
        background: #22c55e;
        color: #fff;
    }

    .number-grid .ragu {
        background: #fbbf24;
        color: #000;
    }

    .number-grid .active-num {
        outline: 3px solid #2563eb;
        outline-offset: -3px;
    }

    .result-box {
        max-width: 600px;
        margin: auto;
        background: #fff;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, .08);
    }

    .score {
        font-size: 56px;
        font-weight: 800;
        color: #2563eb;
    }

    .hidden {
        display: none;
    }

    @media(max-width: 991px) {
        .quiz-layout {
            grid-template-columns: 1fr;
        }

        .quiz-sidebar {
            position: static;
            margin-top: 24px;
        }
    }
</style>
</head>
<body>
    <div class="quiz-wrapper">
        <div id="petunjuk" class="petunjuk-box">
            <h2 class="fw-bold text-primary" style="text-align: center;">Petunjuk Pengerjaan Kuis</h2>
            <ul class="mt-3" style="text-align: justify; list-style-position: outside; padding-left: 20px;">
                <li class="mb-2"><strong>Kuis terdiri</strong> dari 10 soal pilihan ganda, setiap soal memiliki satu jawaban yang benar.</li>
                <li class="mb-2"><strong>Waktu pengerjaan</strong> kuis adalah 30 menit dan ditampilkan dalam bentuk timer di bagian atas layar.</li>
                <li class="mb-2"><strong>Navigasi soal</strong> tersedia di sisi kanan layar. Nomor soal yang sedang dikerjakan ditandai dengan border berwarna biru.</li>
                <li class="mb-2"><strong>Status pengerjaan</strong> soal ditunjukkan dengan warna: <span class="badge bg-success">Hijau</span> untuk soal yang sudah dijawab, <span class="badge bg-warning text-dark">Kuning</span> untuk soal yang ditandai ragu-ragu, dan <span class="badge bg-secondary">Abu-abu</span> untuk soal yang belum dijawab.</li>
                <li class="mb-2"><strong>Tombol Ragu-ragu</strong> dapat digunakan jika peserta belum yakin dengan jawabannya dan ingin meninjaunya kembali sebelum kuis selesai.</li>
                <li class="mb-2">Gunakan tombol <strong>Sebelumnya</strong> dan <strong>Selanjutnya</strong> atau langsung memilih nomor soal pada panel navigasi untuk berpindah antar soal.</li>
                <li class="mb-2">Setelah semua soal dijawab dan sudah yakin, klik tombol <strong>Selesai</strong> untuk mengakhiri kuis.</li>
                <li class="mb-2">Jika <strong>waktu habis</strong> sebelum tombol Selesai ditekan, kuis akan berakhir secara otomatis.</li>
            </ul>
            <div class="d-flex gap-2 mt-4">
                <button class="btn btn-primary px-4 fw-bold" onclick="mulaiKuis()">Mulai Kuis</button>
                <a href="{% url 'ringkasan5' %}" class="btn btn-danger px-4 fw-bold">Batal</a>
            </div>
        </div>

        <div id="kuis" class="quiz-layout hidden">
            <div class="question-card">
                <div class="question-header">
                    <strong>Soal <span id="noSoal">1</span> / 10</strong>
                    <div class="timer">‚è± <span id="timer">30:00</span></div>
                </div>
                <h5 class="mb-4" id="teksSoal">Loading...</h5>
                
                <div id="gambarSoal" class="mb-4 hidden text-center">
                    <img id="imgSoal" class="img-fluid rounded border shadow-sm" style="max-height: 250px;">
                </div>

                <div id="optionsContainer">
                    <div class="option" data-index="0" data-label="a"><span class="teksOpsi"></span></div>
                    <div class="option" data-index="1" data-label="b"><span class="teksOpsi"></span></div>
                    <div class="option" data-index="2" data-label="c"><span class="teksOpsi"></span></div>
                    <div class="option" data-index="3" data-label="d"><span class="teksOpsi"></span></div>
                    <div class="option" data-index="4" data-label="e"><span class="teksOpsi"></span></div>
                </div>
                <div class="nav-btn">
                    <button class="btn btn-nav-prev px-4 py-2 fw-bold" id="btnPrev" onclick="navigasi(-1)">Sebelumnya</button>
                    <button class="btn btn-warning px-4 py-2 fw-bold" onclick="toggleRagu()">Ragu-ragu</button>
                    <button class="btn btn-nav-next px-4 py-2 fw-bold" id="btnNext" onclick="navigasi(1)">Selanjutnya</button>
                </div>
            </div>

            <div class="quiz-sidebar">
                <h6 class="fw-bold mb-3">Nomor Soal</h6>
                <div class="number-grid" id="gridNomor"></div>
                <div class="mt-3 small">
                    <div>üü¢ Sudah dijawab</div>
                    <div>üü° Ragu-ragu</div>
                    <div>‚ö™ Belum dijawab</div>
                </div>
                <button class="btn btn-danger w-100 mt-4 fw-bold" onclick="bukaPeringatanSelesai()">Selesai</button>
            </div>
        </div>

        <div id="hasil" class="result-box hidden">
            <h2 id="statusText" class="fw-bold"></h2>
            <p><b>Nilai Kamu:</b></p>
            <div class="score" id="nilaiAkhir">0</div>
            <div id="loadingHasil" class="mt-3">Menghitung nilai secara aman...</div>
            <div id="lulusBox" class="hidden mt-4">
                <p class="text-success fw-bold">Selamat! Nilai kamu telah memenuhi KKM.</p>
                <p class="text-success fw-bold">Kamu dapat melanjutkan ke bab berikutnya.</p>
                <div class="d-flex justify-content-center gap-2">
                    <a id="btnNextBab" href="{% url 'gray_biner' %}" class="btn btn-primary px-4">Materi Selanjutnya</a>
                </div>
            </div>
            <div id="tidakLulusBox" class="hidden mt-4">
                <p class="text-danger fw-bold">Nilai kamu belum memenuhi KKM.</p>
                <p class="text-info fw-bold">Silakan pelajari kembali materi, kemudian ulangi kuis untuk melanjutkan ke bab berikutnya.</p>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-warning px-4 fw-bold" onclick="ulangKuis()">Ulangi Kuis</button>
                    <a href="{% url 'sharp_citra' %}" class="btn btn-nav-prev px-4 py-2 fw-bold">Pelajari Kembali</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STATIC_URL = "{% static '' %}";
        const soal = [
            {
                q: "Tujuan utama proses sharpening pada citra digital adalah ....",
                o: [
                "Mengurangi noise acak",
                "Menonjolkan perbedaan intensitas agar tepi dan detail objek lebih jelas",
                "Mengubah citra ke domain frekuensi",
                "Menghaluskan seluruh citra",
                "Memperkecil ukuran citra"
                ]
            },
            {
                q: "Kernel Laplacian dengan nilai pusat 8 menghasilkan penajaman yang lebih kuat karena ....",
                o: [
                "Hanya memperhitungkan piksel horizontal",
                "Tidak menggunakan nilai negatif",
                "Ukuran kernel lebih kecil",
                "Tidak melibatkan piksel pusat",
                "Seluruh piksel tetangga termasuk diagonal ikut dihitung"
                ]
            },
            {
                q: "Syarat utama agar area citra yang permukaannya rata tidak berubah setelah sharpening adalah ....",
                o: [
                "Jumlah seluruh nilai kernel sama dengan nol",
                "Kernel harus berukuran besar",
                "Citra harus berwarna",
                "Hanya piksel pusat yang diproses",
                "Semua bobot kernel bernilai positif"
                ]
            },
            {
                q: "Bagian citra yang memiliki intensitas seragam setelah proses sharpening akan ....",
                o: [
                "Menjadi lebih buram",
                "Mengalami peningkatan noise",
                "Berubah drastis",
                "Relatif tidak mengalami perubahan",
                "Menjadi lebih gelap"
                ]
            },
            {
                q: "Perbedaan utama antara smoothing dan sharpening adalah ....",
                o: [
                "Sharpening menegaskan tepi, smoothing meratakan nilai piksel",
                "Smoothing bekerja di domain frekuensi",
                "Sharpening mengurangi noise",
                "Smoothing tidak memproses piksel tetangga",
                "Sharpening hanya untuk citra berwarna"
                ]
            },
            {
                q: "Highboost filtering berbeda dari unsharp masking karena ....",
                o: [
                "Tidak menggunakan citra hasil smoothing",
                "Hanya menggunakan kernel Laplacian",
                "Bekerja pada domain frekuensi",
                "Faktor penguatan k bernilai lebih dari 1",
                "Tidak menggunakan mask"
                ]
            },
            {
                q: "Unsharp masking melakukan penajaman citra dengan cara ....",
                o: [
                "Langsung menerapkan kernel Laplacian",
                "Menurunkan kontras citra",
                "Menambahkan mask hasil selisih citra asli dan citra hasil smoothing",
                "Hanya menggunakan citra hasil smoothing",
                "Menghilangkan seluruh frekuensi rendah"
                ]
            },
            {
                q: "Pada sebuah citra grayscale, terdapat bagian permukaan yang rata dan bagian lain yang memiliki perubahan terang‚Äìgelap yang cukup jelas. Setelah proses sharpening dilakukan, batas antara kedua bagian tersebut terlihat lebih tegas, sementara area yang rata hampir tidak berubah. Kondisi ini menunjukkan bahwa sharpening bekerja dengan cara ....",
                o: [
                "Menghaluskan seluruh permukaan citra",
                "Mengurangi perbedaan intensitas antar piksel",
                "Menegaskan batas perubahan intensitas pada citra",
                "Menyamakan nilai piksel di seluruh area citra",
                "Menghilangkan detail objek pada citra"
                ]
            },
            {
                q: "Perhatikan citra grayscale dan citra blur 4√ó4 di bawah ini! Berdasarkan citra asli dan hasil Gaussian blur yang diberikan, matriks mask yang benar adalah ....",
                o: [
                STATIC_URL + "assets/img/kuis/k5-9-a.png",
                STATIC_URL + "assets/img/kuis/k5-9-b.png",
                STATIC_URL + "assets/img/kuis/k5-9-c.png",
                STATIC_URL + "assets/img/kuis/k5-9-d.png",
                STATIC_URL + "assets/img/kuis/k5-9-e.png"
                ],
                img: STATIC_URL + "assets/img/kuis/k5-9.png"
            },
            {
                q: "Perhatikan citra grayscale 4√ó4 di bawah ini! Nilai mask yang telah diperkuat dengan faktor k = 2 untuk piksel pusat (ditandai warna biru) adalah ....",
                o: ["1", "2", "3", "4", "5"],
                img: STATIC_URL + "assets/img/kuis/k5-10.png"
            }
            ];


        let idx = 0;
        let jawaban = Array(soal.length).fill(null);
        let ragu = Array(soal.length).fill(false);
        let sisaWaktu = 30 * 60;
        let timer;
        let waktuMulaiKuis;
        let waktuSelesaiKuis;

        function formatWaktuSekarang() {
            const sekarang = new Date();
            const utc = sekarang.getTime() + (sekarang.getTimezoneOffset() * 60000);
            const wita = new Date(utc + (3600000 * 8));
            const pad = (n) => n.toString().padStart(2, '0');
            return `${wita.getFullYear()}-${pad(wita.getMonth() + 1)}-${pad(wita.getDate())} ${pad(wita.getHours())}:${pad(wita.getMinutes())}:${pad(wita.getSeconds())}`;
        }

        function mulaiKuis(){
            waktuMulaiKuis = formatWaktuSekarang();
            document.getElementById('petunjuk').classList.add('hidden');
            document.getElementById('kuis').classList.remove('hidden');
            renderGrid();
            renderSoal();
            timer = setInterval(() => {
                sisaWaktu--;
                let m = Math.floor(sisaWaktu/60), d = sisaWaktu%60;
                document.getElementById('timer').innerText = `${String(m).padStart(2,'0')}:${String(d).padStart(2,'0')}`;
                if(sisaWaktu<=0){ 
                    clearInterval(timer); 
                    Swal.fire({
                        title: 'Waktu Habis!',
                        text: 'Waktu pengerjaan kuis telah berakhir.',
                        icon: 'warning',
                        confirmButtonText: 'Ok'
                    }).then(() => {
                        konfirmasiSelesai();
                    });
                }
            }, 1000);
        }

        function renderSoal(){
            document.getElementById('noSoal').innerText = idx + 1;
            document.getElementById('teksSoal').innerText = soal[idx].q;
            
            const containerGambar = document.getElementById('gambarSoal');
            const imgElement = document.getElementById('imgSoal');

            if(soal[idx].img) {
                imgElement.src = soal[idx].img;
                containerGambar.classList.remove('hidden');
            } else {
                imgElement.src = "";
                containerGambar.classList.add('hidden');
            }

            const opts = document.querySelectorAll('.option');
            opts.forEach((opt, i) => {
                opt.classList.remove('selected', 'ragu-selected');
                const teksSpan = opt.querySelector('.teksOpsi');
                const content = soal[idx].o[i];

                if (content.toLowerCase().endsWith('.png') || content.toLowerCase().endsWith('.jpg') || content.toLowerCase().endsWith('.jpeg')) {
                    teksSpan.innerHTML = `<img src="${content}" class="img-option">`;
                } else {
                    teksSpan.innerText = content;
                }

                if(jawaban[idx] === i) {
                    if(ragu[idx]) opt.classList.add('ragu-selected');
                    else opt.classList.add('selected');
                }
            });
            document.getElementById('btnPrev').disabled = (idx === 0);
            document.getElementById('btnNext').innerText = (idx === soal.length - 1) ? "Selesai" : "Selanjutnya";
            updateGridUI();
        }

        function navigasi(step){
            if(step === 1 && idx === soal.length - 1){ 
                bukaPeringatanSelesai(); 
                return; 
            }
            idx += step;
            if(idx < 0) idx = 0;
            if(idx >= soal.length) idx = soal.length - 1;
            renderSoal();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.querySelectorAll('.option').forEach(opt => {
            opt.onclick = function(){
                jawaban[idx] = parseInt(this.getAttribute('data-index'));
                ragu[idx] = false;
                renderSoal();
            }
        });

        function toggleRagu(){ 
            if(jawaban[idx] !== null){ 
                ragu[idx] = !ragu[idx]; 
                renderSoal(); 
                updateGridUI(); 
            } else {
                Swal.fire({
                    icon: 'info',
                    text: 'Pilih jawaban terlebih dahulu sebelum menandai ragu-ragu.',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        function renderGrid(){
            const grid = document.getElementById('gridNomor');
            grid.innerHTML = '';
            soal.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.innerText = i + 1;
                btn.onclick = () => { 
                    idx = i; 
                    renderSoal(); 
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                grid.appendChild(btn);
            });
        }

        function updateGridUI(){
            const btns = document.querySelectorAll('#gridNomor button');
            btns.forEach((btn, i) => {
                btn.classList.remove('done', 'ragu', 'active-num');
                if(i === idx) btn.classList.add('active-num');
                if(ragu[i]) btn.classList.add('ragu');
                else if(jawaban[i] !== null) btn.classList.add('done');
            });
        }

        function bukaPeringatanSelesai() {
            const jumlahRagu = ragu.filter(v => v === true).length;
            const belumDijawab = jawaban.filter(v => v === null).length;

            if (jumlahRagu > 0 || belumDijawab > 0) {
                let pesan = "";
                if (belumDijawab > 0 && jumlahRagu > 0) {
                    pesan = `Masih ada <b>${belumDijawab} soal belum dijawab</b> dan <b>${jumlahRagu} soal ragu-ragu</b>. Silakan lengkapi semua jawaban dan pastikan tidak ada yang ragu-ragu untuk menyelesaikan kuis.`;
                } else if (belumDijawab > 0) {
                    pesan = `Masih ada <b>${belumDijawab} soal yang belum dijawab</b>. Silakan jawab semua soal terlebih dahulu.`;
                } else {
                    pesan = `Masih ada <b>${jumlahRagu} soal yang ditandai ragu-ragu</b>. Silakan pastikan semua jawaban sudah yakin (tidak ragu-ragu).`;
                }

                Swal.fire({
                    title: 'Perhatian',
                    html: pesan,
                    icon: 'warning',
                    showCancelButton: true,
                    showConfirmButton: false,
                    cancelButtonColor: '#6b7280',
                    cancelButtonText: 'Kembali Mengerjakan'
                });
            } else {
                Swal.fire({
                    title: 'Konfirmasi Selesai',
                    text: 'Apakah kamu yakin ingin mengakhiri kuis? Jawaban yang sudah dikirim tidak dapat diubah.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#2563eb',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Ya, Selesai',
                    cancelButtonText: 'Batal',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        konfirmasiSelesai();
                    }
                });
            }
        }

        function konfirmasiSelesai(){
            clearInterval(timer);
            waktuSelesaiKuis = formatWaktuSekarang();
            document.getElementById('kuis').classList.add('hidden');
            document.getElementById('hasil').classList.remove('hidden');
            submitKuis();
        }

        async function submitKuis(){
            try {
                const response = await fetch("{% url 'cek_nilai_kuis_5' %}", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        "jawaban_siswa": jawaban,
                        "waktu_mulai": waktuMulaiKuis,
                        "waktu_selesai": waktuSelesaiKuis
                    })
                });
                if (!response.ok) throw new Error('Gagal menghubungi server');
                const data = await response.json();
                document.getElementById('loadingHasil').classList.add('hidden');
                if (data.skor !== undefined) {
                    document.getElementById('nilaiAkhir').innerText = data.skor;
                    if(data.lulus){
                        document.getElementById('statusText').innerText = 'LULUS';
                        document.getElementById('statusText').className = 'text-success fw-bold';
                        document.getElementById('lulusBox').classList.remove('hidden');
                    } else {
                        document.getElementById('statusText').innerText = 'TIDAK LULUS';
                        document.getElementById('statusText').className = 'text-danger fw-bold';
                        document.getElementById('tidakLulusBox').classList.remove('hidden');
                    }
                }
            } catch (e) {
                document.getElementById('loadingHasil').innerHTML = `<span class="text-danger">${e.message}</span>`;
            }
        }

        function ulangKuis(){ location.reload(); }
    </script>
</body>
</html>