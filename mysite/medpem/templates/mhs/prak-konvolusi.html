{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 6 - Konvolusi{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<style>
.card-section {
    border: 2px solid #bcccdc;
    border-radius: 12px;
    background: #ffffff;
    margin-bottom: 22px;
    box-shadow: 0 6px 18px rgba(16, 32, 58, 0.03);
}

.card-section-header {
    padding: 14px 18px;
    font-size: 20px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 12px;
    background: #edf4fe;
    border-bottom: 2px solid #bcccdc;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

.card-section-header i {
    font-size: 20px;
    color: var(--primary-500);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: rgba(59, 123, 227, 0.12);
}

.card-section-body {
    padding: 35px;
    font-size: 19px;
    color: #222f3a;
    background: #fff;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
}

.step-title {
    font-size: 17pt;
    font-weight: 700;
    margin: 24px 0 10px;
}

.code-box-import {
    background: #eaf3ff;
    border: 2px dashed #b7cff5;
    border-radius: 20px;
    padding: 18px 26px;
    max-width: 520px;
    margin: 26px auto;
    font-family: "Courier New", monospace;
    font-size: 20px;
    text-align: center;
    line-height: 1.6;
    font-weight: 600;
}

.code-box-code {
    max-width: 800px;
    margin: 14px auto 26px;
    padding: 14px 22px;
    background: #ffffff;
    border: 2px solid #3b82f6;
    border-radius: 14px;
    font-family: "Courier New", monospace;
    font-size: 18px;
    line-height: 1.6;
    color: #1e293b;
    font-weight: 600;
}

.keyword { color: #af32bf; }
.module { color: #2b93a3; }
.string { color: #b12121; }
.function { color: #926a39; }
.number { color: #1a8a5f; }

.editor-layout {
    display: flex;
    gap: 24px;
    margin-bottom: 20px;
    align-items: flex-start;
    position: relative;
}

.notebook-container {
    flex: 3;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.sidebar-container {
    flex: 1;
    min-width: 280px;
    position: -webkit-sticky;
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: fit-content;
}

.cell-container {
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
}

.cell-input-area {
    display: flex;
    background: #f8fafc;
    padding: 10px;
    gap: 10px;
}

.cell-info {
    font-family: monospace;
    font-size: 13px;
    color: #1d4ed8;
    min-width: 45px;
    padding-top: 8px;
    text-align: justify;
}

.editor-wrapper {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.CodeMirror {
    height: auto;
    min-height: 40px;
    font-size: 14px;
    background: #282a36 !important;
}

.cell-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.btn-action {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    color: white;
    transition: 0.2s;
}

.btn-run {
    background: #22c55e;
}

.btn-delete {
    background: #ef4444;
}

.cell-output {
    padding: 10px 10px 10px 65px;
    border-top: 1px solid #f1f5f9;
    background: #fff;
}

.output-log {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #475569;
    margin-bottom: 8px;
}

.output-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    margin-top: 5px;
}

.btn-download-manual {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: #3b82f6;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 10px;
    transition: 0.2s;
}

.widget-box {
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 15px;
    background: #f8fafc;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.widget-title {
    font-size: 13px;
    font-weight: 700;
    color: #475569;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.file-list {
    max-height: 150px;
    overflow-y: auto;
    margin: 10px 0;
}

.file-item {
    background: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 4px;
    border: 1px solid #e2e8f0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
}

.file-item.active {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #1d4ed8;
    font-weight: 600;
}

.input-preview {
    width: 100%;
    height: 180px;
    object-fit: contain;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
}

.btn-add-cell-mid {
    height: 12px;
    background: transparent;
    margin: 2px 0;
    position: relative;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
}

.btn-add-cell-mid:hover {
    background: #3b82f6;
    border-radius: 2px;
}

.btn-add-cell-mid i {
    opacity: 0;
    color: white;
    font-size: 14px;
    transition: 0.2s;
}

.btn-add-cell-mid:hover i {
    opacity: 1;
}

#engine-status {
    font-size: 11px;
    color: #64748b;
    font-family: monospace;
    padding: 5px;
    background: #fff;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    text-align: center;
}

.editor-instruction {
    margin-bottom: 20px;
    padding: 15px;
    background: #fdfdfd;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}

.editor-instruction ul { margin: 0; padding-left: 20px; }
.editor-instruction li { margin-bottom: 5px; }

.quiz-container {
    position: relative;
    margin-top: 10px;
    padding: 25px;
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
}

.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.quiz-question {
    display: none;
    animation: fadeIn 0.4s ease;
}

.quiz-question.active { display: block; }

.code-snippet {
    margin: 15px 0;
    padding: 15px;
    background: #ffffff;
    border: 2px solid #3b82f6;
    border-radius: 14px;
    font-family: 'Courier New', monospace;
    line-height: 1.6;
    font-weight: 600;
    font-size: 18px;
    color: #1e293b;
}

.quiz-input {
    padding: 2px 8px;
    background: white;
    border: 2px solid #cbd5e1;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-weight: 600;
    outline: none;
    transition: 0.2s;
    color: #222;
}

.quiz-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 123, 227, 0.1);
}

.quiz-input.correct {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
    color: #1d4ed8 !important;
}

.quiz-input.wrong {
    border-color: #ef4444 !important;
    background-color: #fef2f2 !important;
    color: #dc2626 !important;
}

.feedback-msg {
    display: none;
    margin-top: 10px;
    font-size: 14px;
    font-weight: bold;
}

.feedback-success { color: #16a34a; }
.feedback-error { color: #dc2626; }

.btn-check-answer {
    padding: 10px 24px;
    background-color: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-check-answer:hover {
    background-color: #2563eb;
    color: white;
    transform: translateY(-1px);
}

.btn-check-answer:active {
    transform: translateY(0);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.nav-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin: 20px 0;
}

#quiz-card {
    border: 2.5px solid #4d7bdc !important;
    box-shadow: 0 10px 25px rgba(59, 123, 227, 0.15) !important;
}

#quiz-card .card-section-header {
    background: #4d7bdc !important;
    color: white !important;
}

#quiz-card .card-section-header i {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}
</style>

<h1 class="title-main mb-3">
    SUBBAB 6 – <span style="color:var(--primary-500)">KONVOLUSI</span>
</h1>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-lightbulb"></i> Konvolusi 
    </div>
    <div class="card-section-body">
        <p style="text-align:justify;text-indent:30px;">
            Pustaka <em>Pillow</em> umumnya digunakan untuk membuka, menyimpan, dan melakukan pemrosesan citra dasar. 
            Namun, pada <em>Pillow</em> pengaturan proses <em>convolution</em> dan cara piksel di bagian tepi citra diproses masih terbatas. 
            Oleh karena itu, untuk melakukan <em>convolution</em> dengan pengaturan <em>kernel</em> dan penanganan tepi citra yang lebih lengkap digunakan pustaka <em>SciPy</em>.
        </p>

        <div class="code-box-import">
            <span class="keyword">import</span> <span class="module">numpy</span> <span class="keyword">as</span> <span class="module">np</span><br>
            <span class="keyword">from</span> <span class="module">scipy.signal</span> <span class="keyword">import</span> <span class="module">convolve2d</span>
        </div>

        <p style="text-align:justify;text-indent:30px;">
            <strong><em>SciPy</em></strong> menyediakan fungsi 
            <strong><em>convolve2d</em></strong> yang digunakan untuk melakukan 
            <strong>konvolusi dua dimensi pada data berbentuk matriks</strong>, 
            seperti citra digital yang telah diubah menjadi <em>array</em>. 
            Melalui fungsi ini, pengguna dapat menentukan <em>kernel</em> yang digunakan serta cara penanganan piksel di bagian tepi citra sesuai kebutuhan pemrosesan.
        </p>

        <div class="code-box-code">
            <span class="keyword">import</span> <span class="module">numpy</span> <span class="keyword">as</span> <span class="module">np</span><br>
            <span class="keyword">from</span> <span class="module">PIL</span> <span class="keyword">import</span> <span class="module">Image</span><br>
            <span class="keyword">from</span> <span class="module">scipy.signal</span> <span class="keyword">import</span> <span class="function">convolve2d</span><br><br>
            img = <span class="module">Image</span>.<span class="function">open</span>(<span class="string">"img/rgb.jpg"</span>).<span class="function">convert</span>(<span class="string">"L"</span>)<br>
            image = <span class="module">np</span>.<span class="function">array</span>(img, dtype=<span class="module">np</span>.float32)<br><br>
            kernel = (<span class="number">1</span>/<span class="number">16</span>) * <span class="module">np</span>.<span class="function">array</span>([<br>
            &nbsp;&nbsp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>],<br>
            &nbsp;&nbsp;[<span class="number">2</span>, <span class="number">4</span>, <span class="number">2</span>],<br>
            &nbsp;&nbsp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]<br>
            ], dtype=<span class="module">np</span>.float32)<br><br>
            hasil = <span class="function">convolve2d</span>(<br>
            &nbsp;&nbsp;image,<br>
            &nbsp;&nbsp;kernel,<br>
            &nbsp;&nbsp;mode=<span class="string">"same"</span>,<br>
            &nbsp;&nbsp;boundary=<span class="string">"symm"</span><br>
            )
        </div>

        <p style="text-align:justify;text-indent:30px; margin-left:20px;">
            Pada kode di atas, citra terlebih dahulu dikonversi menjadi <em>grayscale</em>, kemudian diubah ke dalam bentuk <em>array</em> agar dapat diproses menggunakan perhitungan numerik. 
            Kernel yang digunakan adalah kernel <em>smoothing Gaussian</em> 3×3 yang berfungsi untuk menghaluskan citra dengan memberi pengaruh lebih besar pada piksel di sekitar pusat.
        </p>

        <p style="text-align:justify;text-indent:30px; margin-left:20px;">
            Parameter <strong><em>mode="same"</em></strong> digunakan agar ukuran citra hasil konvolusi <strong>tetap sama dengan citra asli</strong>. 
            Sementara itu, parameter <strong><em>boundary="symm"</em></strong> digunakan untuk memberikan <strong><em>padding</em></strong> pada bagian tepi citra dengan cara mencerminkan 
            <strong>(<em>reflect</em>)</strong> nilai piksel di sekitarnya. Selain <em>symm</em>, <em>SciPy</em> juga menyediakan padding lain seperti 
            <strong><em>fill</em></strong> yaitu <strong><em>constant padding</em></strong> yang secara default mengisi tepi citra dengan nilai nol 
            (<em>zero padding</em>), namun nilainya dapat diatur menggunakan parameter <strong><em>fillvalue</em></strong>, misalnya <em>fillvalue=128</em>. 
            <em>SciPy</em> juga menyediakan padding <strong><em>wrap</em></strong>, yaitu padding yang mengisi tepi citra menggunakan piksel dari sisi berlawanan sehingga citra diperlakukan seolah-olah melingkar.
        </p>


        <p style="text-align:justify;text-indent:30px; margin-left:20px;">
            Hasil konvolusi kadang menghasilkan nilai piksel yang terlalu kecil (kurang dari 0) atau terlalu besar (lebih dari 255). 
            Padahal citra <em>grayscale</em> hanya dapat menampilkan nilai piksel dalam rentang 0 sampai 255. 
            Oleh karena itu, nilai piksel hasil konvolusi perlu disesuaikan kembali agar sesuai dengan rentang nilai citra <em>digital</em>.
        </p>

        <div class="code-box-code">
            hasil_out = hasil.<span class="function">copy</span>()<br><br>
            min_val = hasil.<span class="function">min</span>()<br>
            max_val = hasil.<span class="function">max</span>()<br><br>
            mask_low = hasil < <span class="number">0</span><br>
            mask_high = hasil > <span class="number">255</span><br><br>
            <span class="keyword">if</span> min_val < <span class="number">0</span> <span class="keyword">or</span> max_val > <span class="number">255</span>:<br>
            &nbsp;&nbsp;&nbsp;&nbsp;hasil_norm = (hasil - min_val) / (max_val - min_val) * <span class="number">255</span><br><br>
            &nbsp;&nbsp;&nbsp;&nbsp;hasil_out[mask_low] = hasil_norm[mask_low]<br>
            &nbsp;&nbsp;&nbsp;&nbsp;hasil_out[mask_high] = hasil_norm[mask_high]<br><br>
            hasil_conv = hasil_out.<span class="function">astype</span>(<span class="module">np</span>.uint8)<br>
            <span class="module">Image</span>.<span class="function">fromarray</span>(hasil_conv)
        </div>

        <p style="text-align:justify;text-indent:30px; margin-left:20px;">
            Pada kode di atas, nilai piksel terkecil dan terbesar dari hasil konvolusi dicari terlebih dahulu. 
            Jika terdapat nilai piksel yang berada di luar rentang 0–255, maka nilai tersebut disesuaikan kembali agar semua piksel berada dalam rentang yang digunakan pada citra <em>grayscale</em>. 
            Setelah itu, citra diubah ke tipe data <em>uint8</em> sehingga dapat digunakan sebagai citra <em>grayscale</em> dan diproses atau disimpan kembali. 
            Dengan cara ini, hasil konvolusi tetap dapat digunakan tanpa mengubah informasi penting pada citra.
        </p>

    </div>
</section>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-journal-code"></i> SFiltering CitraLab
    </div>
    <div class="card-section-body">
        <div class="editor-instruction">
            <strong><i class="bi bi-info-circle text-primary"></i> Langkah-langkah Penggunaan Editor:</strong>
            <ul>
                <li>Pastikan status editor pada sidebar kanan bawah menunjukkan <span class="text-success fw-bold">“Editor Siap”</span> sebelum mulai menggunakan editor.</li>
                <li>Unggah gambar melalui tombol <strong>Unggah</strong> <i class="bi bi-upload ms-1"></i> pada sidebar.</li>
                <li>Gambar yang diunggah atau dipilih dari Galeri Citra SFiltering akan otomatis ditampilkan pada <strong>pratinjau gambar</strong> <i class="bi bi-image ms-1"></i>.</li>
                <li>Klik nama file pada Galeri Citra <i class="bi bi-files"></i>, dan nama file akan otomatis digunakan pada <strong>sel pertama</strong>.</li>
                <li>Klik ikon <strong>Jalankan</strong> <i class="bi bi-play-fill text-success ms-1"></i> di sebelah kanan sel untuk memproses gambar.</li>
                <li>Arahkan kursor ke bagian bawah sel, lalu klik ikon <i class="bi bi-plus-circle text-primary ms-1"></i> untuk menambahkan sel baru.</li>
                <li>Klik ikon <i class="bi bi-trash text-danger ms-1"></i> pada sel yang tidak diperlukan.</li>
                <li>Setelah kode berhasil dijalankan, hasil pemrosesan akan ditampilkan di bawah sel</i>.</li>
                <li>Klik tombol <strong>Unduh Gambar</strong> <i class="bi bi-download ms-1"></i> untuk menyimpan hasil pemrosesan.</li>
            </ul>
        </div>

        <div class="editor-layout">
            <div class="notebook-container" id="notebook"></div>
            <div class="sidebar-container">
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-image"></i> Pratinjau Gambar</div>
                    <img id="input-display" class="input-preview" src="https://via.placeholder.com/300x200?text=Pilih+Gambar">
                </div>
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-files"></i> Galeri Citra SFiltering</div>
                    <label for="image-upload" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-upload"></i> Upload
                    </label>
                    <input type="file" id="image-upload" style="display: none;" accept="image/*" multiple>
                    <div id="file-list-names" class="file-list"></div>
                    <button class="btn btn-sm btn-link text-danger p-0" onclick="clearFiles()">Hapus Semua</button>
                </div>
                <div id="engine-status">Memuat Editor...</div>
            </div>
        </div>
    </div>
</section>

<section class="card-section" id="quiz-card">
    <div class="card-section-header">
        <i class="bi bi-pencil-square"></i> Aktivitas 2
    </div>
    <div class="card-section-body">
        <div class="quiz-container">
            <div class="quiz-header">
                <span id="quiz-badge" class="badge bg-primary">Soal 1 / 1</span>
                <span class="text-muted small">Selesaikan soal untuk melanjutkan materi</span>
            </div>

            <div id="q1" class="quiz-question active">
                <p>1. Perhatikan potongan kode Python berikut:</p>
                
                <div class="code-snippet">
                    img = <span class="module">Image</span>.<span class="function">open</span>(<span class="string">"img/rgb.jpg"</span>).<span class="function">convert</span>(<span class="string">"L"</span>)<br>
                    image = <span class="module">np</span>.<span class="function">array</span>(img, dtype=<span class="module">np</span>.float32)<br><br>
                    kernel = (<span class="number">1</span>/<span class="number">16</span>) * <span class="module">np</span>.<span class="function">array</span>([<br>
                    &nbsp;&nbsp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>],<br>
                    &nbsp;&nbsp;[<span class="number">2</span>, <span class="number">4</span>, <span class="number">2</span>],<br>
                    &nbsp;&nbsp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]<br>
                    ], dtype=<span class="module">np</span>.float32)<br><br>
                    hasil = <input type="text" id="quiz-1" class="quiz-input" style="width:140px" placeholder=". . ." oninput="handleInput(this)"> (<br>
                    &nbsp;&nbsp;image,<br>
                    &nbsp;&nbsp;kernel,<br>
                    &nbsp;&nbsp;mode= <span class="string">"</span><input type="text" id="quiz-2" class="quiz-input" style="width:80px" placeholder="..." oninput="handleInput(this)"><span class="string">"</span>,<br>
                    &nbsp;&nbsp;boundary= <span class="string">"</span><input type="text" id="quiz-3" class="quiz-input" style="width:80px" placeholder="..." oninput="handleInput(this)"><span class="string">"</span><br>
                    )
                </div>
                <p style="text-align:justify;">
                    Lengkapilah bagian kode yang kosong agar proses konvolusi citra menggunakan Gaussian kernel 3×3 dapat berjalan dengan ukuran output sama seperti citra input!
                </p>
                <div id="feedback-quiz" class="feedback-msg"></div>
                <div class="mt-4">
                    <button id="btn-check-quiz" class="btn-check-answer" onclick="validateQuiz()">Cek Jawaban</button>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="nav-container">
    <a href="{% url 'gray_biner' %}" class="btn btn-outline-secondary">
        <i class="bi bi-chevron-left"></i> Sebelumnya
    </a>
    <a id="nextBtnMaterial" href="{% url 'prak_smooth' %}" 
       class="btn btn-primary {% if 'prak-konvolusi' not in selesai_slugs %}disabled{% endif %}" 
       style="{% if 'prak-konvolusi' not in selesai_slugs %}opacity:0.5; pointer-events:none;{% endif %}">
        Selanjutnya <i class="bi bi-chevron-right"></i>
    </a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let pyodideInstance;
let fileStore = {};
let notebookCells = [
    { 
        id: 'c1', 
        content: `import numpy as np\nfrom PIL import Image\nfrom scipy.signal import convolve2d\n\nimg = Image.open("pilih_gambar.jpg").convert("L")\nimage = np.array(img, dtype=np.float32)\n\nkernel = (1/16) * np.array([\n    [1, 2, 1],\n    [2, 4, 2],\n    [1, 2, 1]\n], dtype=np.float32)\n\nhasil = convolve2d(image, kernel, mode="same", boundary="symm")\n\nhasil_out = hasil.copy()\nmin_val, max_val = hasil.min(), hasil.max()\n\nif min_val < 0 or max_val > 255:\n    hasil_out = (hasil - min_val) / (max_val - min_val) * 255\n\nhasil_conv = hasil_out.astype(np.uint8)\nimg_final = Image.fromarray(hasil_conv)\nimg_final.save("hasil_konvolusi.png")\nimg_final`, 
        output: null, 
        log: null, 
        fileName: "" 
    }
];
let editors = {};

function handleInput(el) {
    const feedback = document.getElementById('feedback-quiz');
    
    // Jika input yang sedang diketik sebelumnya berstatus salah (merah)
    if (el.classList.contains('wrong')) {
        feedback.style.display = 'none'; // Sembunyikan pesan feedback "Masih ada jawaban..."
    }
    
    // Reset warna kotak input menjadi default
    el.className = "quiz-input";
}

function updateProgressDatabase() {
    fetch("/api/update-progres/", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ slug: 'prak-konvolusi' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const navBtn = document.getElementById('nextBtnMaterial');
            navBtn.classList.remove('disabled');
            navBtn.style.opacity = '1';
            navBtn.style.pointerEvents = 'auto';
            
            const badge = document.getElementById('quiz-badge');
            badge.innerText = 'Selesai';
            badge.classList.replace('bg-primary', 'bg-success');
        }
    });
}

function validateQuiz() {
    const q1 = document.getElementById('quiz-1');
    const q2 = document.getElementById('quiz-2');
    const q3 = document.getElementById('quiz-3');
    const feedback = document.getElementById('feedback-quiz');

    const check1 = q1.value.trim() === "convolve2d";
    const check2 = q2.value.trim().replace(/['"]/g, "") === "same";
    const check3 = ["symm", "fill", "wrap"].includes(q3.value.trim().replace(/['"]/g, ""));

    q1.className = check1 ? "quiz-input correct" : "quiz-input wrong";
    q2.className = check2 ? "quiz-input correct" : "quiz-input wrong";
    q3.className = check3 ? "quiz-input correct" : "quiz-input wrong";

    if (check1 && check2 && check3) {
        feedback.innerText = "Benar!";
        feedback.className = "feedback-msg feedback-success";
        feedback.style.display = "block";

        Swal.fire({
            title: 'Luar Biasa!',
            text: 'Semua jawaban kamu benar. Lanjutkan ke materi berikutnya.',
            icon: 'success',
            confirmButtonText: 'Siap!',
            confirmButtonColor: '#3b82f6'
        }).then(() => {
            q1.disabled = true;
            q2.disabled = true;
            q3.disabled = true;
            updateProgressDatabase();
        });
    } else {
        feedback.innerText = "Masih ada jawaban yang belum tepat. Periksa kembali.";
        feedback.className = "feedback-msg feedback-error";
        feedback.style.display = "block";
    }
}

async function initPyodide() {
    try {
        pyodideInstance = await loadPyodide();
        await pyodideInstance.loadPackage(["micropip"]);
        const micropip = pyodideInstance.pyimport("micropip");
        await micropip.install(["pillow", "numpy", "scipy"]);
        
        await pyodideInstance.runPythonAsync(`
import io, base64
from PIL import Image
import __main__
def get_image_as_base64(var_name):
    try:
        obj = getattr(__main__, var_name, None)
        if obj and isinstance(obj, Image.Image):
            buf = io.BytesIO()
            obj.save(buf, format='PNG')
            return base64.b64encode(buf.getvalue()).decode('utf-8')
    except: pass
    return None
        `);
        document.getElementById("engine-status").innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Editor Siap';
        renderNotebook();
    } catch (e) {
        document.getElementById("engine-status").innerText = "Editor Error";
    }
}

function renderNotebook() {
    const container = document.getElementById("notebook");
    const scrollPos = window.scrollY;
    container.innerHTML = "";
    notebookCells.forEach((cell, index) => {
        const cellDiv = document.createElement("div");
        const hasOutput = cell.output || cell.log;
        cellDiv.innerHTML = `
            <div class="cell-container" id="cell-${cell.id}">
                <div class="cell-input-area">
                    <div class="cell-info">In [${index + 1}]</div>
                    <div class="editor-wrapper"><textarea id="edit-ctrl-${cell.id}">${cell.content}</textarea></div>
                    <div class="cell-actions">
                        <button class="btn-action btn-run" onclick="runCell('${cell.id}')"><i class="bi bi-play-fill"></i></button>
                        <button class="btn-action btn-delete" onclick="deleteCell('${cell.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="cell-output" id="out-${cell.id}" style="${hasOutput ? 'display: block;' : 'display: none;'}">
                    <div class="output-log" id="log-${cell.id}" style="${cell.log && !cell.log.includes('Error') ? 'color: #22c55e;' : 'color: #ef4444;'}">${cell.log || ''}</div>
                    <img class="output-image" id="img-${cell.id}" src="${cell.output || ''}" style="${cell.output ? 'display: block;' : 'display: none;'}">
                    <a id="dl-${cell.id}" class="btn-download-manual" href="${cell.output || ''}" download="${cell.fileName || 'hasil.png'}" style="${cell.output ? 'display: inline-flex;' : 'display: none;'}"><i class="bi bi-download"></i> Unduh Gambar</a>
                </div>
            </div>
            <div class="btn-add-cell-mid" onclick="addNewCellAt(${index + 1})"><i class="bi bi-plus-circle"></i></div>
        `;
        container.appendChild(cellDiv);
        const editor = CodeMirror.fromTextArea(document.getElementById(`edit-ctrl-${cell.id}`), {
            mode: "python", theme: "dracula", lineNumbers: true, indentUnit: 4, viewportMargin: Infinity
        });
        editor.on("change", (cm) => {
            const cellObj = notebookCells.find(c => c.id === cell.id);
            if(cellObj) cellObj.content = cm.getValue();
        });
        editors[cell.id] = editor;
    });
    window.scrollTo(0, scrollPos);
}

function addNewCellAt(index) {
    const newId = 'c' + Date.now();
    notebookCells.splice(index, 0, { id: newId, content: "", output: null, log: null, fileName: "" });
    renderNotebook();
}

function deleteCell(id) {
    if (notebookCells.length === 1) return;
    notebookCells = notebookCells.filter(c => c.id !== id);
    delete editors[id];
    renderNotebook();
}

async function runCell(id) {
    const code = editors[id].getValue();
    const cellObj = notebookCells.find(c => c.id === id);
    const logLabel = document.getElementById(`log-${id}`);
    const imgElement = document.getElementById(`img-${id}`);
    const dlBtn = document.getElementById(`dl-${id}`);
    const outArea = document.getElementById(`out-${id}`);

    outArea.style.display = "block";
    logLabel.innerText = "Memproses...";
    try {
        await pyodideInstance.runPythonAsync(code);
        const lines = code.trim().split('\n');
        const lastLine = lines[lines.length - 1].trim();
        
        let targetFileName = "hasil_praktikum.png";
        const saveMatch = code.match(/\.save\(\s*["']([^"']+)["']\s*\)/);
        if (saveMatch) targetFileName = saveMatch[1];
        
        const base64Data = await pyodideInstance.runPythonAsync(`get_image_as_base64("${lastLine}")`);
        if (base64Data) {
            const url = `data:image/png;base64,${base64Data}`;
            cellObj.output = url;
            cellObj.log = "Berhasil diproses";
            cellObj.fileName = targetFileName;
            imgElement.src = url;
            imgElement.style.display = "block";
            dlBtn.href = url;
            dlBtn.download = targetFileName;
            dlBtn.style.display = "inline-flex";
        } else {
            cellObj.log = "Selesai dijalankan.";
            imgElement.style.display = "none";
        }
        logLabel.innerText = cellObj.log;
        logLabel.style.color = "#22c55e";
    } catch (err) {
        logLabel.innerText = "Error:\n" + err;
        logLabel.style.color = "#ef4444";
    }
}

document.getElementById("image-upload").addEventListener("change", (e) => {
    const files = e.target.files;
    const list = document.getElementById("file-list-names");
    for (const file of files) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            pyodideInstance.FS.writeFile(file.name, data);
            const url = URL.createObjectURL(new Blob([data], {type: file.type}));
            fileStore[file.name] = url;
            const item = document.createElement("div");
            item.className = "file-item";
            item.innerHTML = `<span>${file.name}</span><i class="bi bi-check2 text-success"></i>`;
            item.onclick = () => {
                document.querySelectorAll(".file-item").forEach(el => el.classList.remove("active"));
                item.classList.add("active");
                document.getElementById("input-display").src = url;
                if (notebookCells.length > 0) {
                    let first = editors[notebookCells[0].id].getValue();
                    const updated = first.replace(/Image\.open\s*\(\s*["']([^"']*)["']\s*\)/g, `Image.open("${file.name}")`);
                    editors[notebookCells[0].id].setValue(updated);
                }
            };
            list.appendChild(item);
            item.click();
        };
        reader.readAsArrayBuffer(file);
    }
});

function clearFiles() {
    Object.keys(fileStore).forEach(f => {
        try { pyodideInstance.FS.unlink(f); } catch(e) {}
        URL.revokeObjectURL(fileStore[f]);
    });
    fileStore = {};
    document.getElementById("file-list-names").innerHTML = "";
    document.getElementById("input-display").src = "https://via.placeholder.com/300x200?text=Pilih+Gambar";
}


document.addEventListener("DOMContentLoaded", function() {
    initPyodide();
});
</script>

{% endblock %}