{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 5 - Sharpening Citra Digital{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  .card-section {
    border: 2px solid #bcccdc;
    border-radius: 12px;
    overflow: hidden;
    background: #ffffff;
    margin-bottom: 22px;
    box-shadow: 0 6px 18px rgba(16,32,58,0.03);
  }
  .card-section-header {
    padding: 14px 18px;
    font-size: 20px;
    font-weight: 800;
    display:flex;
    align-items:center;
    gap:12px;
    background: #edf4fe;
    border-bottom: 2px solid #bcccdc;
  }
  .card-section-header i {
    font-size:20px;
    color:var(--primary-500);
    display:inline-flex;
    width:36px;
    height:36px;
    align-items:center;
    justify-content:center;
    border-radius:8px;
    background: rgba(59,123,227,0.12);
  }
  .card-section-body {
    padding: 35px;
    font-size: 19px;
    color: #222f3a;
    background: #fff;
  }
  .card-section-body p { margin-bottom:12px; line-height:1.6; }
  .card-section-body ol { margin-top:8px; padding-left:35px; }
  .card-section-body li { 
    margin-bottom:12px; 
    font-size:19px; 
  }
  .material-nav { display:flex; gap:12px; justify-content:flex-end; margin-top:18px; margin-bottom:34px; }

  .conv-container { display:flex; flex-direction:column; gap:18px; align-items:center; }
  .conv-top { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; width:100%; }
  .conv-section { background:#faf9f7; border-radius:12px; padding:14px; box-shadow: 0 4px 10px rgba(0,0,0,0.04); text-align:center; min-width:220px; }
  .conv-table { border-collapse:collapse; margin:8px auto; }
  .conv-table td { width:44px; height:44px; border:1px solid #999; text-align:center; vertical-align:middle; font-weight:700; padding:0; transition:background-color .18s; }
  .input-cell, .output-cell { background:#fff9ee; }
  .padding-cell { background:#bcccdc !important; font-weight:700; color: #444; }
  .input-highlight { background:#d9eafd !important; font-weight:800; color:#0b2540; }
  .output-highlight { background:#003049 !important; color:#fff !important; font-weight:800; }
  .kernel-cell { background:#d9eafd; padding:0; font-weight:800; text-align:center; }
  
  .conv-controls { display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:12px; }
  .conv-controls button { padding:10px 16px; border-radius:10px; border:none; color:#fff; font-weight:800; cursor:pointer; font-family: inherit; }
  
  .btn-mulai, .btn-pause, .btn-resume, .btn-lanjut { background:#3b7dd8; color: white !important; }
  .btn-autoplay { background:#fff; color:#3b7dd8 !important; border:1px solid rgba(16,32,58,0.15) !important; }
  .btn-ulangi { background:#fff; color:#3b7dd8 !important; border:1px solid rgba(16,32,58,0.06) !important; }

  .calc-wrapper { width: 100%; max-width: 800px; margin-top: 10px; }
  .calc-title { font-weight: 800; color: #003049; margin-bottom: 5px; text-align: center; font-size: 15px; }
  .calculation { background-color: #faf9f7; border-radius: 10px; box-shadow: 0 6px 18px #edf4fe; padding: 15px; text-align:center; font-family: 'Courier New', monospace; color:#333; min-height:50px; border: 1px solid #eee; font-size: 18px; font-weight: 700; line-height: 1.4; }

  .select-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; width: 100%; align-items: flex-end; }
  .custom-select-box { display: inline-block !important; width: auto !important; padding: 6px 8px !important; font-size: 13px !important; font-weight: 700 !important; color: #444 !important; background-color: #fff !important; border: 2px solid #3b7dd8 !important; border-radius: 8px !important; }
  .control-label { display: block; text-align: center; font-weight: 800; font-size: 10px; margin-bottom: 2px; color: #666; text-transform: uppercase; }
  #constInputGroup { width: 60px; display: none; }
  .const-input { width: 100%; padding: 6px 2px; border: 2px solid #3b7dd8; border-radius: 8px; text-align: center; font-weight: 700; font-size: 13px; }

  .option-btn { display: block; width: 100%; text-align: left; margin-bottom: 8px; padding: 12px; border-radius: 8px; border: 1px solid rgba(16,32,58,0.1); background: #fff; transition: all 0.2s; cursor: pointer; }
  .option-label { font-weight: 800; margin-right: 10px; color: #000000; }
  #quiz-card {
    border: 2.5px solid #4d7bdc !important;
    box-shadow: 0 10px 25px rgba(59, 123, 227, 0.15) !important;
  }

  #quiz-card .card-section-header {
    background: #4d7bdc !important;
    border-bottom: 2px solid #4d7bdc; 
    color: white !important;
  }

  #quiz-card .card-section-header i {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
  }
  .kernel-wrapper {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 30px 0;
    flex-wrap: wrap;
  }

  .kernel-card {
    border: 1px solid #dcdde1;
    border-radius: 10px;
    background-color: #fff;
    min-width: 300px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .kernel-card:hover {
    border-color: #bcccdc;
  }

  .kernel-header {
    background-color: #fcfcfc;
    padding: 12px;
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid #eee;
    border-radius: 10px 10px 0 0;
    font-size: 1.1em;
    color: #2c3e50;
  }

  .kernel-math {
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 260px; 
  }

  .kernel-footer {
    margin-top: auto; 
    padding: 15px;
    text-align: center;
    border-top: 1px dashed #eee;
    background-color: #fafafa;
    border-radius: 0 0 10px 10px;
  }

  .kernel-footer strong {
    display: block;
    margin-bottom: 5px;
    color: #333;
  }

  .kernel-footer span {
    font-size: 0.9em;
    color: #666;
    line-height: 1.4;
    display: block;
  }

  .math-container {
    font-size: 1.2em;
  }

  .laplacian-box {
    max-width: 900px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
  }

  .laplacian-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 40px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .laplacian-matrix,
  .laplacian-calc {
    font-size: 20px;
  }

  hr {
    border: none;
    border-top: 1px solid #ccc;
    margin: 30px 0;
  }
</style>

<div class="mb-3">
  <h1 class="title-main">SUBBAB 5 - <span style="color:var(--primary-500)"><em>SHARPENING</em> CITRA DIGITAL</span></h1>
</div>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-journal-bookmark"></i>
    <div>Tujuan Pembelajaran</div>
  </div>
  <div class="card-section-body">
    <p class="muted">Setelah menyelesaikan pembelajaran pada bab ini, mahasiswa diharapkan mampu:</p>
    <ol>
      <li>Memahami konsep <em>Sharpening</em> pada citra digital.</li>
      <li>Memahami perbedaan <em>Smoothing</em> dan <em>Sharpening</em> pada <em>Spatial Filters</em>.</li>
      <li>Menerapkan teknik <em>Sharpening</em> menggunakan <em>Unsharp Masking</em> dan <em>Highboost Filtering</em> pada matriks citra sederhana.</li>
    </ol>
  </div>
</section>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-lightbulb"></i>
    <div><em>Sharpening</em> Citra Digital</div>
  </div>
  <div class="card-section-body">
    <p style="text-align: justify; text-indent: 30px;">
      Ketika kita melihat sebuah citra terdapat bagian yang tampak jelas dan tegas seperti tepi objek, garis bangunan, atau detail wajah, serta bagian lain yang terlihat lebih lembut dan rata. 
      Dalam pemrosesan citra digital <strong>penekanan terhadap bagian-bagian yang tegas</strong> tersebut dapat dilakukan melalui proses <strong>penajaman (<em>sharpening</em>)</strong>.
    </p>

    <p style="text-align: justify; text-indent: 30px;">
      <strong><em>Sharpening</em></strong> merupakan proses yang bertujuan untuk <strong>menonjolkan perbedaan intensitas antar piksel</strong>, 
      sehingga tepi dan detail objek terlihat lebih jelas. Berbeda dengan <em>smoothing</em> yang berfungsi meratakan nilai piksel dan dapat melembutkan tepi, 
      <em>sharpening</em> justru <strong>memperkuat perubahan intensitas</strong> agar detail yang sebelumnya melemah menjadi lebih tegas dan mudah dikenali.
    </p>

    <figure style="margin:20px 0;">
      <img src="{% static 'assets/img/konten/1E.png' %}" style="display:block; margin:auto; width:95%;">
      <figcaption style="color:#7f7f7f; margin-top:8px; text-align:center; font-weight:normal;">
        Gambar E.1 Citra <em>grayscale</em> dan hasil <em>sharpening</em> menggunakan kernel 3x3
      </figcaption>
    </figure>

    <p style="text-align: justify; text-indent: 30px;">
      Pada Gambar E.1 menunjukkan perbandingan citra <em>grayscale</em> sebelum dan sesudah proses <em>sharpening</em>. 
      Setelah penajaman, tepi objek seperti batas antara cabai dan paprika terlihat lebih tegas dan jelas karena perbedaan terang-gelapnya semakin kuat. 
      Sementara itu, bagian citra yang permukaannya rata atau seragam tetap terlihat sama dan tidak banyak berubah.
    </p>

    <figure style="margin:20px 0;">
      <img src="{% static 'assets/img/konten/2E.png' %}" style="display:block; margin:auto; width:40%;">
      <figcaption style="color:#7f7f7f; margin-top:8px; text-align:center; font-weight:normal;">
        Gambar E.2 Citra <em>grayscale</em> anak tangga
      </figcaption>
    </figure>

    <p style="text-align: justify; text-indent: 30px;">
      Salah satu cara umum untuk melakukan penajaman citra adalah menggunakan operator Laplacian, 
      yaitu metode yang menonjolkan perubahan intensitas yang tajam antara piksel pusat dan piksel di sekitarnya. 
      Pada bagian citra yang relatif seragam, seperti dinding atau lantai yang rata, perubahan intensitas 
      antar piksel sangat kecil sehingga bagian tersebut hampir tidak mengalami perubahan setelah proses penajaman.
    </p>

    <p style="text-align: justify; text-indent: 30px;">
      Sebaliknya, pada bagian citra yang memiliki perubahan intensitas yang jelas, seperti tepi objek atau 
      batas antar bidang, bagian tepinya menjadi lebih menonjol. Hal ini dapat dianalogikan dengan anak tangga 
      pada Gambar E.2, di mana setiap tepi anak tangga memiliki perbedaan ketinggian yang jelas. 
      Proses penajaman bekerja dengan menegaskan batas-batas tersebut sehingga struktur objek terlihat lebih tegas.
    </p>

    <div class="kernel-wrapper">
      <div class="kernel-card">
        <div class="kernel-header">Kernel Laplacian</div>
        <div class="kernel-math">
          <div class="math-container">
            $$
            \begin{bmatrix}
            0 & -1 & 0 \\
            -1 & 4 & -1 \\
            0 & -1 & 0
            \end{bmatrix}
            $$
          </div>
        </div>
        <div class="kernel-footer">
          <strong>Kernel 3×3 (Pusat 4)</strong>
          <span>Menegaskan tepi horizontal dan vertikal.</span>
        </div>
      </div>

      <div class="kernel-card">
        <div class="kernel-header">Kernel Laplacian</div>
        <div class="kernel-math">
          <div class="math-container">
            $$
            \begin{bmatrix}
            -1 & -1 & -1 \\
            -1 & 8 & -1 \\
            -1 & -1 & -1
            \end{bmatrix}
            $$
          </div>
        </div>
        <div class="kernel-footer">
          <strong>Kernel 3×3 (Pusat 8)</strong>
          <span>Penajaman lebih kuat ke semua arah.</span>
        </div>
      </div>
    </div>


    <p style="text-align: justify; text-indent: 30px;">
      Perbedaan kedua <em>kernel</em> Laplacian terletak pada cara bobot disebarkan di sekitar piksel pusat. 
      Pada <em>kernel</em> dengan nilai pusat 4 hanya piksel di atas, bawah, kiri, dan kanan yang diberi bobot −1, sedangkan piksel diagonal tidak ikut dihitung. 
      Akibatnya penajaman yang dihasilkan cenderung lebih lembut dan menegaskan tepi pada arah horizontal dan vertikal.
    </p>

    <p style="text-align: justify; text-indent: 30px;">
      Sementara itu, pada <em>kernel</em> dengan nilai pusat 8, seluruh piksel di sekeliling pusat termasuk yang berada pada posisi diagonal diberi bobot −1. 
      Karena lebih banyak piksel tetangga yang dibandingkan, <em>kernel</em> ini menghasilkan efek penajaman yang lebih kuat dan membuat tepi objek terlihat lebih tegas ke berbagai arah seperti yang diperlihatkan pada Gambar E.3.
    </p>

    <figure style="margin:20px 0;">
      <img src="{% static 'assets/img/konten/3E.png' %}" style="display:block; margin:auto; width:95%;">
      <figcaption style="color:#7f7f7f; margin-top:8px; text-align:center; font-weight:normal;">
        Gambar E.3 Contoh citra <em>grayscale</em> menggunakan <em>kernel</em> Laplacian pusat 4 dan pusat 8
      </figcaption>
    </figure>
  </div>
</section>


<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-intersect"></i>
    <div>Mengapa kernel Laplacian berjumlah nol?</div>
  </div>
  <div class="card-section-body">
    
    <p style="text-align: justify; text-indent: 30px;">
      Syarat utama agar bagian citra yang permukaannya rata tidak ikut berubah saat proses penajaman adalah jumlah seluruh nilai pada <em>kernel</em> harus sama dengan nol. 
      Kondisi ini memastikan bahwa <em>kernel</em> tidak menambah atau mengurangi tingkat kecerahan pada area yang memiliki nilai piksel seragam.
    </p>

    <p style="text-align: justify; text-indent: 30px;">
      Secara matematis, syarat tersebut dituliskan sebagai berikut:
    </p>

    <p style="text-align: center; font-size: 27px;">
      $$
      \sum\limits_{j=-1}^{1}
      \sum\limits_{k=-1}^{1}
      h(j,k) = 0
      $$
    </p>

    <p style="text-align: justify; text-indent: 30px;">
      <p>
      Persamaan tersebut menunjukkan bahwa nilai-nilai dalam <em>kernel</em> saling menyeimbangkan, sehingga area citra dengan intensitas yang sama tidak mengalami perubahan. 
      Sebaliknya, area yang memiliki perbedaan intensitas seperti tepi objek atau detail halus akan menjadi lebih menonjol. 
      Akibatnya, citra terlihat lebih tajam dan batas antar objek menjadi lebih jelas.
    </p>

    <div class="laplacian-box">
      <strong>Contoh pada kernel Laplacian:</strong>
      <div class="laplacian-row">
        <div class="laplacian-matrix">
          $$
          \begin{bmatrix}
          0 & -1 & 0 \\
          -1 & 4 & -1 \\
          0 & -1 & 0
          \end{bmatrix}
          $$
        </div>

        <div class="laplacian-calc">
          $$
          0 + (-1) + 0 + (-1) + 4 + (-1) + 0 + (-1) + 0 = 0
          $$
        </div>
      </div>
      <hr>
      <div class="laplacian-row">
        <div class="laplacian-matrix">
          $$
          \begin{bmatrix}
          -1 & -1 & -1 \\
          -1 & 8 & -1 \\
          -1 & -1 & -1
          \end{bmatrix}
          $$
        </div>

        <div class="laplacian-calc">
          $$
          (-1) + (-1) + (-1) + (-1) + 8 + (-1) + (-1) + (-1) + (-1) = 0
          $$
        </div>
      </div>
    </div>

    <p style="text-align: justify; text-indent: 30px;">
      Pada contoh perhitungan dua <em>kernel</em> Laplacian di atas ditunjukkan bahwa keduanya memenuhi syarat penajaman yaitu jumlah seluruh elemen <em>kernel</em> bernilai nol. 
      Pada masing-masing <em>kernel</em> nilai positif dan negatif dijumlahkan sehingga hasil akhirnya sama dengan nol. 
      Hal ini menunjukkan bahwa pengaruh setiap nilai pada <em>kernel</em> saling mengimbangi. 
      Akibatnya, area citra dengan intensitas yang relatif sama tidak mengalami perubahan, sedangkan area dengan perbedaan intensitas yang jelas, seperti tepi objek, akan menjadi lebih menonjol setelah proses penajaman.
    </p>
  </div>
</section>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-images"></i>
    <div>Konvolusi dengan </em>Kernel Sharpening</em></div>
  </div>
  <div class="card-section-body">

    <p>
      Contoh <em>sharpening filtering</em> menggunakan citra 4×4 dan <em>kernel</em> 3×3.
    </p>

    <figure style="margin:20px 0; margin-bottom: 70px">
      <img src="{% static 'assets/img/konten/contoh.png' %}" style="display:block; margin:auto; width:60%;">
    </figure>


    <div class="conv-container">
      <div class="conv-top">
        <div class="conv-section">
          <h4><b>Input Citra (Matriks)</b></h4>
          <table id="inputMatrix" class="conv-table"></table>
        </div>

        <div class="conv-section" style="min-width:360px;">
          <h4><b>Kernel</b></h4>
          
          <div class="select-row">
            <div class="select-group">
              <label class="control-label">Pilih Kernel:</label>
              <select id="kernelSelect" class="custom-select-box">
                <option value="laplacian4">Laplacian 4</option>
                <option value="laplacian8">Laplacian 8</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            
            <div class="select-group">
              <label class="control-label">Pilih Padding:</label>
              <select id="paddingSelect" class="custom-select-box">
                <option value="zero">Zero</option>
                <option value="replicate">Replicate</option>
                <option value="reflect">Reflect</option>
                <option value="wrap">Wrap</option>
                <option value="constant">Constant</option>
              </select>
            </div>

            <div class="select-group" id="constInputGroup">
              <label class="control-label">Val</label>
              <input type="number" id="constVal" class="const-input" value="1" min="1" max="255">
            </div>
          </div>

          <table id="kernelMatrix" class="conv-table"></table>
          
          <div class="conv-controls">
            <button id="startBtn" class="btn-mulai">Mulai</button>
            <button id="autoplayBtn" class="btn-autoplay">Auto Play</button>
            <button id="pauseBtn" class="btn-pause" style="display:none;">Pause</button>
            <button id="resumeBtn" class="btn-resume" style="display:none;">Resume</button>
            <button id="nextBtn" class="btn-lanjut" style="display:none;">Lanjut</button>
            <button id="resetBtn" class="btn-ulangi" style="display:none;">Ulangi</button>
          </div>
        </div>

        <div class="conv-section">
          <h4><b>Hasil Konvolusi</b></h4>
          <table id="outputMatrix" class="conv-table"></table>
        </div>
      </div>

      <div class="calc-wrapper">
        <div class="calc-title">PERHITUNGAN:</div>
        <div class="calculation" id="calculationText">Belum ada perhitungan</div>
      </div>
    </div>
  </div>
</section>

<section class="card-section" id="quiz-card">
  <div class="card-section-header">
    <i class="bi bi-question-circle"></i>
    <div>Aktivitas 1</div>
  </div>
  <div class="card-section-body">
    <p class="muted">Pilih jawaban yang paling tepat. Jika jawaban belum tepat, silakan coba lagi sampai benar.</p>
    <div id="question-counter" style="font-weight:700; margin-bottom:12px;">Soal 1 / 5</div>
    
    <div id="question-area">
      <div id="question-text" style="font-weight:800; font-size:18px; margin-bottom:15px;"></div>
      <div id="options-container"></div>
    </div>
    <div id="quiz-feedback" style="min-height:48px; margin-top:15px;"></div>
    <div style="margin-top:20px;">
      <button id="next-quiz-btn" class="btn btn-primary" disabled>Selanjutnya</button>
    </div>
  </div>
</section>

<div class="material-nav">
  <a href="{% url 'normalisasi_citra' %}" class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i> Sebelumnya</a>
  <a id="nav-next-materi" href="{% url 'um_highboost' %}" 
     class="btn btn-primary {% if 'sharp-citra' not in selesai_slugs %}disabled{% endif %}" 
     style="{% if 'sharp-citra' not in selesai_slugs %}opacity: 0.5; pointer-events: none;{% endif %}">
    Selanjutnya <i class="bi bi-chevron-right"></i>
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const inputData = [[84,86,80,89],[88,93,86,89],[83,56,41,24],[17,9,19,30]];
  const kernels = { 
    laplacian4: [[0,-1,0],[-1,4,-1],[0,-1,0]], 
    laplacian8: [[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],
    custom: [[0,0,0],[0,0,0],[0,0,0]] 
  };

  let currentKernel = kernels.laplacian4;
  let paddingType = 'zero';
  let outputData = Array.from({length:4}, ()=>Array(4).fill(''));
  let step = 0;
  let autoInterval = null;
  let isPaused = false;

  const inputTable = document.getElementById('inputMatrix');
  const kernelTable = document.getElementById('kernelMatrix');
  const outputTable = document.getElementById('outputMatrix');
  const calcText = document.getElementById('calculationText');
  const constGroup = document.getElementById('constInputGroup');
  const constValInp = document.getElementById('constVal');
  
  const startBtn = document.getElementById('startBtn');
  const autoplayBtn = document.getElementById('autoplayBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const nextBtn = document.getElementById('nextBtn');
  const resetBtn = document.getElementById('resetBtn');
  const btnNavNext = document.getElementById('nav-next-materi');

  function createTable(matrix, table, cellClass='input-cell', editable=false){
    table.innerHTML = '';
    matrix.forEach((row,i)=>{
      const tr = document.createElement('tr');
      row.forEach((val,j)=>{
        const td = document.createElement('td');
        td.textContent = (val === '' || typeof val === 'undefined') ? '' : String(val);
        if(table.id === 'inputMatrix'){
          if(i===0 || j===0 || i===matrix.length-1 || j===matrix[0].length-1) td.classList.add('padding-cell');
          else td.classList.add('input-cell');
        } else td.classList.add(cellClass);
        if(editable){
          td.contentEditable = true;
          td.addEventListener('blur', () => { 
            let v = parseInt(td.textContent); 
            currentKernel[i][j] = isNaN(v) ? 0 : v; 
          });
        }
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });
  }

  function getPaddedValue(x,y){
    const rows = inputData.length, cols = inputData[0].length;
    if(x >= 0 && x < rows && y >= 0 && y < cols) return inputData[x][y];
    switch(paddingType) {
      case 'replicate': return inputData[Math.min(Math.max(x,0), rows-1)][Math.min(Math.max(y,0), cols-1)];
      case 'reflect':
        let rx = x < 0 ? Math.abs(x) : (x >= rows ? 2 * rows - x - 2 : x);
        let ry = y < 0 ? Math.abs(y) : (y >= cols ? 2 * cols - y - 2 : y);
        return inputData[rx][ry];
      case 'wrap':
        let wx = (x % rows + rows) % rows;
        let wy = (y % cols + cols) % cols;
        return inputData[wx][wy];
      case 'constant':
        let cVal = parseInt(constValInp.value);
        return isNaN(cVal) ? 0 : Math.min(Math.max(cVal, 0), 255);
      case 'zero': default: return 0;
    }
  }

  function updateInputTable(){
    const rows = inputData.length, cols = inputData[0].length;
    let padded = [];
    for(let i=-1;i<rows+1;i++){
      const r = [];
      for(let j=-1;j<cols+1;j++) r.push(getPaddedValue(i,j));
      padded.push(r);
    }
    createTable(padded, inputTable);
  }

  function processStep(){
    const positions = [];
    for(let i=0;i<4;i++) for(let j=0;j<4;j++) positions.push([i,j]);
    
    if(step >= positions.length){
      clearInterval(autoInterval);
      autoInterval = null;
      nextBtn.style.display = 'none';
      pauseBtn.style.display = 'none';
      resumeBtn.style.display = 'none';
      resetBtn.style.display = 'inline-block';
      return;
    }

    const [ox,oy] = positions[step];
    updateInputTable();
    for(let i=0; i<3; i++) for(let j=0; j<3; j++) inputTable.rows[ox+i].cells[oy+j].classList.add('input-highlight');
    
    let sum = 0;
    let detail = [];
    for(let i=-1;i<=1;i++) {
      for(let j=-1;j<=1;j++) {
        let val = getPaddedValue(ox+i, oy+j);
        let kVal = currentKernel[i+1][j+1];
        sum += val * kVal;
        detail.push(`(<span style="color:#3b7dd8">${kVal}</span>×${val})`);
      }
    }
    outputData[ox][oy] = sum;
    createTable(outputData, outputTable, 'output-cell');
    outputTable.rows[ox].cells[oy].classList.add('output-highlight');
    calcText.innerHTML = `${detail.join("+")} = <b>${sum}</b>`;
    
    step++;

    if(step >= positions.length) {
      clearInterval(autoInterval);
      autoInterval = null;
      nextBtn.style.display = 'none';
      pauseBtn.style.display = 'none';
      resumeBtn.style.display = 'none';
      resetBtn.style.display = 'inline-block';
    }
  }

  startBtn.onclick = () => {
    step = 0;
    outputData = Array.from({length:4}, ()=>Array(4).fill(''));
    createTable(outputData, outputTable, 'output-cell');
    startBtn.style.display = 'none';
    autoplayBtn.style.display = 'none';
    nextBtn.style.display = 'inline-block';
    resetBtn.style.display = 'inline-block';
    processStep();
  };

  autoplayBtn.onclick = () => {
    step = 0;
    outputData = Array.from({length:4}, ()=>Array(4).fill(''));
    createTable(outputData, outputTable, 'output-cell');
    startBtn.style.display = 'none';
    autoplayBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    resetBtn.style.display = 'inline-block';
    nextBtn.style.display = 'none';
    isPaused = false;
    processStep();
    autoInterval = setInterval(processStep, 1000);
  };

  pauseBtn.onclick = () => {
    clearInterval(autoInterval);
    autoInterval = null;
    isPaused = true;
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'inline-block';
  };

  resumeBtn.onclick = () => {
    isPaused = false;
    resumeBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    processStep();
    autoInterval = setInterval(processStep, 1000);
  };

  resetBtn.onclick = () => {
    step = 0; isPaused = false;
    if(autoInterval) clearInterval(autoInterval);
    autoInterval = null;
    outputData = Array.from({length:4}, ()=>Array(4).fill(''));
    createTable(outputData, outputTable, 'output-cell');
    updateInputTable();
    calcText.textContent = 'Belum ada perhitungan';
    startBtn.style.display = 'inline-block';
    autoplayBtn.style.display = 'inline-block';
    nextBtn.style.display = 'none';
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'none';
    resetBtn.style.display = 'none';
  };

  document.getElementById('kernelSelect').onchange = (e) => {
    const val = e.target.value;
    currentKernel = kernels[val];
    createTable(currentKernel, kernelTable, 'kernel-cell', val === 'custom');
  };

  document.getElementById('paddingSelect').onchange = (e) => {
    paddingType = e.target.value;
    constGroup.style.display = (paddingType === 'constant') ? 'block' : 'none';
    updateInputTable();
  };

  constValInp.oninput = () => {
    if(paddingType === 'constant') {
      updateInputTable();
    }
  };

  nextBtn.onclick = processStep;
  updateInputTable();
  createTable(outputData, outputTable, 'output-cell');
  createTable(currentKernel, kernelTable, 'kernel-cell');

  const questions = [
    { 
      q: 'Tujuan utama proses sharpening pada citra digital adalah ….',
      opts: [
        'menghilangkan seluruh noise pada citra',
        'menonjolkan perbedaan intensitas antar piksel sehingga tepi terlihat lebih jelas',
        'meratakan nilai piksel agar citra lebih halus',
        'mengubah citra ke domain frekuensi',
        'mengurangi resolusi citra'
      ],
      ans: 'menonjolkan perbedaan intensitas antar piksel sehingga tepi terlihat lebih jelas',
      explain: 'sharpening bertujuan memperkuat perbedaan intensitas antar piksel agar tepi dan detail objek menjadi lebih jelas.'
    },
    { 
      q: 'Perbedaan utama antara smoothing dan sharpening adalah ….',
      opts: [
        'sharpening memperkuat perubahan intensitas sedangkan smoothing meratakannya',
        'keduanya selalu menggunakan kernel yang sama',
        'smoothing hanya digunakan pada citra berwarna',
        'sharpening tidak melibatkan piksel tetangga',
        'keduanya bertujuan memperhalus citra'
      ],
      ans: 'sharpening memperkuat perubahan intensitas sedangkan smoothing meratakannya',
      explain: 'smoothing berfungsi meratakan nilai piksel sehingga citra lebih halus, sedangkan sharpening mempertegas perubahan intensitas pada tepi.'
    },
    { 
      q: 'Bagian citra yang permukaannya relatif seragam setelah proses sharpening akan ….',
      opts: [
        'mengalami peningkatan noise',
        'menjadi lebih terang',
        'menjadi lebih kabur',
        'tidak mengalami perubahan yang signifikan',
        'menghilang dari citra'
      ],
      ans: 'tidak mengalami perubahan yang signifikan',
      explain: 'pada area dengan intensitas seragam, nilai kernel saling menyeimbangkan sehingga tidak terjadi perubahan berarti.'
    },
    { 
      q: 'Kernel Laplacian dengan nilai pusat 4 memiliki karakteristik utama yaitu ….',
      opts: [
        'tidak menggunakan nilai negatif',
        'menegaskan tepi ke semua arah termasuk diagonal',
        'menegaskan tepi pada arah horizontal dan vertikal',
        'menghasilkan efek smoothing yang kuat',
        'tidak memenuhi syarat penajaman'
      ],
      ans: 'menegaskan tepi pada arah horizontal dan vertikal',
      explain: 'kernel Laplacian pusat 4 hanya melibatkan piksel atas, bawah, kiri, dan kanan sehingga penajaman dominan pada arah horizontal dan vertikal.'
    },
    { 
      q: 'Syarat utama agar proses penajaman tidak mengubah area citra yang seragam adalah ….',
      opts: [
        'nilai pusat kernel harus bernilai positif',
        'ukuran kernel harus ganjil',
        'kernel hanya berisi nilai negatif',
        'kernel tidak boleh memiliki piksel diagonal',
        'jumlah seluruh elemen kernel harus sama dengan nol'
      ],
      ans: 'jumlah seluruh elemen kernel harus sama dengan nol',
      explain: 'jika jumlah seluruh elemen kernel bernilai nol, maka pada area dengan intensitas seragam hasil konvolusi tidak menambah atau mengurangi kecerahan.'
    }
  ];

  let currentIdx = 0;
  const qText = document.getElementById('question-text');
  const optsCont = document.getElementById('options-container');
  const feedback = document.getElementById('quiz-feedback');
  const btnNextQuiz = document.getElementById('next-quiz-btn');

  function renderQuestion(idx) {
    const item = questions[idx];
    document.getElementById('question-counter').textContent = `Soal ${idx + 1} / ${questions.length}`;
    qText.textContent = item.q;
    optsCont.innerHTML = '';
    feedback.innerHTML = '';
    btnNextQuiz.disabled = true;

    const labels = ['a', 'b', 'c', 'd', 'e'];
    item.opts.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.innerHTML = `<span class="option-label">${labels[i]}.</span> ${opt}`;
      btn.onclick = () => {
        Array.from(optsCont.children).forEach(child => {
          child.style.background = '#fff';
          child.style.borderColor = 'rgba(16,32,58,0.1)';
        });
        if (opt === item.ans) {
          btn.style.background = '#e9f2ff';
          btn.style.borderColor = '#3b7be3';
          feedback.innerHTML = `<div style="color:green;font-weight:700">Benar! — ${item.explain}</div>`;
          btnNextQuiz.disabled = false;
          Array.from(optsCont.children).forEach(b => b.style.pointerEvents = 'none');
        } else {
          btn.style.background = '#fff0f0';
          btn.style.borderColor = '#f5c6c6';
          feedback.innerHTML = '<div style="color:#c0392b;font-weight:700">Belum tepat, coba lagi.</div>';
        }
      };
      optsCont.appendChild(btn);
    });
  }

  function updateProgressDatabase() {
    fetch("/api/update-progres/", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ slug: 'sharp-citra' })
    })
    .then(async response => {
      const isJson = response.headers.get('content-type')?.includes('application/json');
      const data = isJson ? await response.json() : null;
      if (!response.ok) throw new Error((data && data.message) || 'Terjadi kesalahan.');
      return data;
    })
    .then(data => {
      if (data.status === 'success') {
        Swal.fire({
          title: 'Luar Biasa!',
          text: 'Semua jawaban kamu benar. Silakan lanjutkan ke materi berikutnya.',
          icon: 'success',
          confirmButtonText: 'OK',
          confirmButtonColor: '#3b7be3'
        }).then(() => {
          btnNavNext.classList.remove('disabled');
          btnNavNext.style.opacity = '1';
          btnNavNext.style.pointerEvents = 'auto';
          currentIdx = 0;
          renderQuestion(0);
        });
      }
    })
    .catch(err => {
      Swal.fire('Gagal Simpan', err.message, 'error');
    });
  }

  btnNextQuiz.onclick = () => {
    currentIdx++;
    if (currentIdx < questions.length) renderQuestion(currentIdx);
    else {
      updateProgressDatabase();
    }
  };

  renderQuestion(0);
});
</script>
{% endblock %}