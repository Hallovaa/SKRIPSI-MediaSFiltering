{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 6 - Praktikum{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<style>
.card-section {
  border: 1px solid rgba(16,32,58,0.08);
  border-radius: 12px;
  background: #fff;
  margin-bottom: 22px;
  box-shadow: 0 6px 18px rgba(16,32,58,0.03);
}

.card-section-header {
  padding: 14px 18px;
  font-size: 18px;
  font-weight: 800;
  display:flex;
  align-items:center;
  gap:12px;
  background: #edf4fe;
  border-bottom: 1px solid rgba(16,32,58,0.06);
}

.card-section-header i {
  font-size:20px;
  color:var(--primary-500);
  width:36px;height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  background: rgba(59,123,227,0.12);
}

.card-section-body {
  padding: 20px;
  font-size: 16px;
  color: #222;
  line-height: 1.7;
}

.editor-layout { display: flex; gap: 20px; margin-bottom: 20px; }
.editor-side { flex: 2; min-width: 0; }
.upload-side { flex: 1; min-width: 0; }

.editor-wrapper { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; position: relative; }
.CodeMirror { height: 400px; font-size: 14px; }

.btn-run-icon { 
  position: absolute; bottom: 15px; right: 20px; z-index: 10;
  width: 50px; height: 50px; border-radius: 50%; 
  background: #28a745; color: white; border: none; 
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; box-shadow: 0 4px 12px rgba(40,167,69,0.4);
  transition: 0.3s; cursor: pointer;
}
.btn-run-icon:hover { transform: scale(1.1); background: #218838; }
.btn-run-icon:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

.upload-box {
  border: 1px solid #dee2e6; border-radius: 10px; padding: 15px;
  background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; height: 100%;
}

.file-list-container {
  margin-top: 10px; display: flex; flex-direction: column; gap: 8px;
  max-height: 300px; overflow-y: auto;
}

.file-item {
  background: #f8fafc; padding: 10px 15px; border-radius: 8px;
  font-size: 13px; color: #334155; display: flex; justify-content: space-between;
  align-items: center; border: 1px solid #e2e8f0; cursor: pointer;
  transition: all 0.2s;
}

.file-item:hover { background: #f1f5f9; border-color: #94a3b8; }
.file-item.active { 
    background: #eff6ff; 
    border-color: #3b82f6; 
    color: #1d4ed8;
    font-weight: 600;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

#console-log { background: #1e1e1e; color: #00ff00; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; margin-top: 15px; min-height: 40px; white-space: pre-wrap; border: 1px solid #333; }

.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
.preview-box { border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fafafa; text-align: center; }

.preview-box img { 
  width: 100%; height: auto; max-height: 400px; object-fit: contain; 
  background: #fff; margin-top: 10px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
  .editor-layout { flex-direction: column; }
  .preview-grid { grid-template-columns: 1fr; }
}
</style>

<h1 class="title-main mb-3">
  SUBBAB 6 – <span style="color:var(--primary-500)">PRAKTIKUM</span>
</h1>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-code-slash"></i>
    Interactive Image Processing
  </div>
  <div class="card-section-body">
    
    <div class="editor-layout">
      <div class="editor-side">
        <div class="editor-wrapper">
          <textarea id="python-editor">from PIL import Image

# Pilih gambar di samping untuk mengganti path di bawah otomatis
img = Image.open("pilih_gambar.jpg")
gray = img.convert("L")   
gray.save("Hasil_grayscale.png")</textarea>
          <button id="run-button" class="btn-run-icon" disabled title="Jalankan Kode">
            <i class="bi bi-play-fill"></i>
          </button>
        </div>
      </div>

      <div class="upload-side">
        <div class="upload-box">
          <label for="image-upload" class="btn btn-primary w-100">
            <i class="bi bi-upload"></i> Upload Gambar
          </label>
          <input type="file" id="image-upload" style="display: none;" accept="image/*" multiple>
          
          <div id="file-list-names" class="file-list-container">
            <div class="text-center text-muted small py-4">Belum ada file diunggah</div>
          </div>

          <button class="btn btn-sm btn-link text-danger mt-auto" onclick="clearFiles()">Hapus Semua File</button>
        </div>
      </div>
    </div>

    <div id="console-log">Menginisialisasi Engine...</div>

    <div class="preview-grid">
      <div class="preview-box">
        <span class="badge bg-primary mb-2">Input Terpilih</span>
        <img id="input-display" src="https://via.placeholder.com/500x300?text=Pilih+File+di+Daftar" alt="Input">
      </div>
      <div class="preview-box">
        <span class="badge bg-success mb-2">Hasil Output</span>
        <img id="output-display" src="https://via.placeholder.com/500x300?text=Menunggu+Eksekusi" alt="Output">
      </div>
    </div>

  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
let pyodideInstance;
let fileStore = {};
let lastUsedFileName = "";

const editor = CodeMirror.fromTextArea(document.getElementById("python-editor"), {
    mode: "python",
    theme: "dracula",
    lineNumbers: true,
    indentUnit: 4,
    smartIndent: true
});

const logArea = document.getElementById("console-log");
const runBtn = document.getElementById("run-button");
const fileInput = document.getElementById("image-upload");
const fileListName = document.getElementById("file-list-names");
const inputImg = document.getElementById("input-display");
const outputImg = document.getElementById("output-display");

async function init() {
    try {
        pyodideInstance = await loadPyodide();
        await pyodideInstance.loadPackage(["micropip"]);
        const micropip = pyodideInstance.pyimport("micropip");
        await micropip.install(["pillow", "numpy", "scikit-image", "scipy"]);
        logArea.innerText = "Engine Siap. Silakan pilih gambar.";
        runBtn.disabled = false;
    } catch (e) {
        logArea.innerText = "Error: " + e;
    }
}

init();

function syncCode(fileName) {
    let code = editor.getValue();
    const regex = /(?:Image\.open|imread|io\.imread|open)\s*\(\s*["']([^"']*)["']/g;
    
    let newCode = code.replace(regex, (match) => {
        const func = match.split('(')[0];
        return `${func}("${fileName}"`;
    });

    if (newCode !== code) {
        editor.setValue(newCode);
    }
}

fileInput.addEventListener("change", async (e) => {
    const files = e.target.files;
    if (files.length === 0) return;

    if (Object.keys(fileStore).length === 0) fileListName.innerHTML = "";
    
    for (const file of files) {
        const fileName = file.name;
        const reader = new FileReader();
        
        reader.onload = async (ev) => {
            const data = new Uint8Array(ev.target.result);
            pyodideInstance.FS.writeFile(fileName, data);
            
            const blobUrl = URL.createObjectURL(new Blob([data], {type: file.type}));
            fileStore[fileName] = blobUrl;

            const fileItem = document.createElement("div");
            fileItem.className = "file-item";
            fileItem.id = `item-${fileName.replace(/[^a-z0-9]/gi, '')}`;
            fileItem.innerHTML = `<span>${fileName}</span><i class="bi bi-chevron-right"></i>`;
            
            fileItem.onclick = () => {
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                fileItem.classList.add('active');
                
                inputImg.src = blobUrl;
                syncCode(fileName);
                lastUsedFileName = fileName;
                logArea.innerText = `Input aktif: ${fileName}`;
                outputImg.src = "https://via.placeholder.com/500x300?text=Klik+Play+untuk+Proses+Baru";
            };

            fileListName.appendChild(fileItem);
            fileItem.click();
        };
        reader.readAsArrayBuffer(file);
    }
});

function clearFiles() {
    Object.keys(fileStore).forEach(f => {
        try { pyodideInstance.FS.unlink(f); } catch(e) {}
    });
    fileStore = {};
    fileListName.innerHTML = '<div class="text-center text-muted small py-4">Belum ada file diunggah</div>';
    inputImg.src = "https://via.placeholder.com/500x300?text=Pilih+File+di+Daftar";
    outputImg.src = "https://via.placeholder.com/500x300?text=Menunggu+Eksekusi";
    logArea.innerText = "Sistem dibersihkan.";
}

runBtn.addEventListener("click", async () => {
    const code = editor.getValue();
    logArea.innerText = "Memproses gambar...";
    
    try {
        const outputNames = ["output.png", "hasil.png", "result.png", "Hasil_grayscale.png", "output.jpg"];
        outputNames.forEach(name => {
            try { pyodideInstance.FS.unlink(name); } catch(e) {}
        });

        const beforeFiles = new Set(pyodideInstance.FS.readdir('.'));
        await pyodideInstance.runPythonAsync(code);
        const afterFiles = pyodideInstance.FS.readdir('.');
        
        let newFile = null;
        for (const f of afterFiles) {
            if (!beforeFiles.has(f) && /\.(png|jpg|jpeg|bmp)$/i.test(f)) {
                newFile = f;
                break;
            }
        }

        if (!newFile) {
            for (const name of outputNames) {
                if (pyodideInstance.FS.analyzePath(name).exists) {
                    newFile = name;
                    break;
                }
            }
        }

        if (newFile) {
            const data = pyodideInstance.FS.readFile(newFile);
            const blob = new Blob([data.buffer], { type: "image/png" });
            const url = URL.createObjectURL(blob);
            outputImg.src = url;
            
            const link = document.createElement("a");
            link.href = url;
            link.download = "hasil_" + newFile;
            link.click();
            
            logArea.innerText = `Berhasil! Output: ${newFile}`;
        } else {
            logArea.innerText = "Proses selesai, namun tidak ada file gambar output yang disimpan.";
        }
    } catch (err) {
        logArea.innerText = "Kesalahan Kode:\n" + err;
    }
});
</script>

{% endblock %} 



{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 6 - Praktikum{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<style>
.card-section {
  border: 1px solid rgba(16,32,58,0.08);
  border-radius: 12px;
  background: #fff;
  margin-bottom: 22px;
  box-shadow: 0 6px 18px rgba(16,32,58,0.03);
}

.card-section-header {
  padding: 14px 18px;
  font-size: 18px;
  font-weight: 800;
  display:flex;
  align-items:center;
  gap:12px;
  background: #edf4fe;
  border-bottom: 1px solid rgba(16,32,58,0.06);
}

.card-section-header i {
  font-size:20px;
  color:var(--primary-500);
  width:36px;height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  background: rgba(59,123,227,0.12);
}

.card-section-body {
  padding: 20px;
  font-size: 16px;
  color: #222;
  line-height: 1.7;
}

.step-title{
  font-size:12pt;
  font-weight:700;
  margin:24px 0 10px;
}

.code-box-import{
  background:#eaf3ff;
  border:2px dashed #b7cff5;
  border-radius:20px;
  padding:18px 26px;
  max-width:520px;
  margin:26px auto;
  font-family:"Courier New", monospace;
  font-size:20px;
  text-align:center;
  line-height:1.6;
}

.code-box-code{
  background:#f8fbff;
  border:2px solid #3b82f6;
  border-radius:14px;
  padding:14px 22px;
  max-width:700px;
  margin:14px auto 26px;
  font-family:"Courier New", monospace;
  font-size:16px;
  line-height:1.6;
}

.keyword{color:#c026d3;font-weight:600;}
.module{color:#0f766e;}
.string{color:#b91c1c;}

.editor-layout { display: flex; gap: 20px; margin-bottom: 20px; }
.editor-side { flex: 2; min-width: 0; }
.upload-side { flex: 1; min-width: 0; }

.editor-wrapper { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; position: relative; }
.CodeMirror { height: 400px; font-size: 14px; }

.btn-run-icon { 
  position: absolute; bottom: 15px; right: 20px; z-index: 10;
  width: 50px; height: 50px; border-radius: 50%; 
  background: #28a745; color: white; border: none; 
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; box-shadow: 0 4px 12px rgba(40,167,69,0.4);
  transition: 0.3s; cursor: pointer;
}
.btn-run-icon:hover { transform: scale(1.1); background: #218838; }
.btn-run-icon:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

.upload-box {
  border: 1px solid #dee2e6; border-radius: 10px; padding: 15px;
  background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; height: 100%;
}

.file-list-container {
  margin-top: 10px; display: flex; flex-direction: column; gap: 8px;
  max-height: 300px; overflow-y: auto;
}

.file-item {
  background: #f8fafc; padding: 10px 15px; border-radius: 8px;
  font-size: 13px; color: #334155; display: flex; justify-content: space-between;
  align-items: center; border: 1px solid #e2e8f0; cursor: pointer;
  transition: all 0.2s;
}

.file-item:hover { background: #f1f5f9; border-color: #94a3b8; }
.file-item.active { 
    background: #eff6ff; 
    border-color: #3b82f6; 
    color: #1d4ed8;
    font-weight: 600;
}

#console-log { background: #1e1e1e; color: #00ff00; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; margin-top: 15px; min-height: 40px; white-space: pre-wrap; border: 1px solid #333; }

.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
.preview-box { border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fafafa; text-align: center; }

.preview-box img { 
  width: 100%; height: auto; max-height: 400px; object-fit: contain; 
  background: #fff; margin-top: 10px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
  .editor-layout { flex-direction: column; }
  .preview-grid { grid-template-columns: 1fr; }
}
</style>

<h1 class="title-main mb-3">
  SUBBAB 6 – <span style="color:var(--primary-500)">PRAKTIKUM</span>
</h1>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-journal-bookmark"></i>
    Tujuan Pembelajaran
  </div>
  <div class="card-section-body">
    <ul>
      <li>Memahami konsep citra digital.</li>
      <li>Mengubah citra RGB menjadi grayscale.</li>
      <li>Mengubah citra grayscale menjadi biner.</li>
    </ul>
  </div>
</section>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-lightbulb"></i>
    Citra <em>grayscale</em> dan citra biner
  </div>

  <div class="card-section-body">
    <p style="text-align:justify;text-indent:30px;">
      Pengolahan citra digital adalah proses mengolah dan memperbaiki gambar menggunakan komputer agar 
      tampilannya lebih jelas atau sesuai kebutuhan. Salah satu bahasa pemrograman yang banyak digunakan 
      dalam pengolahan citra adalah Python. Selain mudah dipelajari, Python memiliki banyak pustaka 
      (library) yang sangat membantu dalam memproses gambar. Pada materi ini kita akan menggunakan 
      pustaka Pillow, yaitu library Python yang dapat membaca, menampilkan, dan memodifikasi citra.
    </p>

    <div class="code-box-import">
      <span class="keyword">from</span>
      <span class="module">PIL</span>
      <span class="keyword">import</span>
      <span class="module">Image</span><br>
      <span class="keyword">from</span>
      <span class="module">PIL</span>
      <span class="keyword">import</span>
      <span class="module">ImageFilter</span>
    </div>

    <p style="text-align:justify;text-indent:30px;">
      Dua modul yang akan kita gunakan adalah Image dan ImageFilter. Modul Image merupakan modul utama 
      untuk bekerja dengan citra. Melalui modul ini kita dapat membuka gambar menggunakan Image.open(), 
      mengubah mode warna, mengubah ukuran, memutar gambar, hingga menyimpan kembali citra yang telah diproses.
    </p>

    <div class="step-title">1) Mengubah gambar berwarna (RGB) menjadi gambar <em>grayscale</em></div>
    <div class="code-box-code">
      img = Image.open(<span class="string">"gambar.jpg"</span>)<br>
      gray = img.convert(<span class="string">"L"</span>)
    </div>

    <div class="step-title">2) Mengubah gambar <em>grayscale</em> menjadi gambar <em>biner</em></div>
    <div class="code-box-code">
      img = Image.open(<span class="string">"gambar.jpg"</span>).convert(<span class="string">"L"</span>)<br>
      threshold = int(sum(img.getdata()) / len(img.getdata()))<br>
      binary_img = img.point(<span class="keyword">lambda</span> x: 255 <span class="keyword">if</span> x &gt; threshold <span class="keyword">else</span> 0)
    </div>
  </div>
</section>

<section class="card-section">
  <div class="card-section-header">
    <i class="bi bi-code-slash"></i>
    Interactive Image Processing Editor
  </div>
  <div class="card-section-body">
    
    <div class="editor-layout">
      <div class="editor-side">
        <div class="editor-wrapper">
          <textarea id="python-editor">from PIL import Image

img = Image.open("pilih_gambar.jpg")
gray = img.convert("L")   
gray.save("Hasil_grayscale.png")</textarea>
          <button id="run-button" class="btn-run-icon" disabled title="Jalankan Kode">
            <i class="bi bi-play-fill"></i>
          </button>
        </div>
      </div>

      <div class="upload-side">
        <div class="upload-box">
          <label for="image-upload" class="btn btn-primary w-100">
            <i class="bi bi-upload"></i> Upload Gambar
          </label>
          <input type="file" id="image-upload" style="display: none;" accept="image/*" multiple>
          
          <div id="file-list-names" class="file-list-container">
            <div class="text-center text-muted small py-4">Belum ada file diunggah</div>
          </div>

          <button class="btn btn-sm btn-link text-danger mt-auto" onclick="clearFiles()">Hapus Semua File</button>
        </div>
      </div>
    </div>

    <div id="console-log">Menginisialisasi Engine...</div>

    <div class="preview-grid">
      <div class="preview-box">
        <span class="badge bg-primary mb-2">Input Terpilih</span>
        <img id="input-display" src="https://via.placeholder.com/500x300?text=Pilih+File+di+Daftar" alt="Input">
      </div>
      <div class="preview-box">
        <span class="badge bg-success mb-2">Hasil Output</span>
        <img id="output-display" src="https://via.placeholder.com/500x300?text=Menunggu+Eksekusi" alt="Output">
      </div>
    </div>

  </div>
</section>

<div class="material-nav mt-4">
  <a href="{% url 'pengertian_citra' %}" class="btn btn-outline-secondary">
    <i class="bi bi-chevron-left"></i> Sebelumnya
  </a>
  <a href="{% url 'jenis_citra' %}" class="btn btn-primary">
    Selanjutnya <i class="bi bi-chevron-right"></i>
  </a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
let pyodideInstance;
let fileStore = {};

const editor = CodeMirror.fromTextArea(document.getElementById("python-editor"), {
    mode: "python",
    theme: "dracula",
    lineNumbers: true,
    indentUnit: 4,
    smartIndent: true
});

const logArea = document.getElementById("console-log");
const runBtn = document.getElementById("run-button");
const fileInput = document.getElementById("image-upload");
const fileListName = document.getElementById("file-list-names");
const inputImg = document.getElementById("input-display");
const outputImg = document.getElementById("output-display");

async function init() {
    try {
        pyodideInstance = await loadPyodide();
        await pyodideInstance.loadPackage(["micropip"]);
        const micropip = pyodideInstance.pyimport("micropip");
        await micropip.install(["pillow", "numpy", "scikit-image", "scipy"]);
        logArea.innerText = "Engine Siap. Silakan pilih gambar.";
        runBtn.disabled = false;
    } catch (e) {
        logArea.innerText = "Error: " + e;
    }
}

init();

function syncCode(fileName) {
    let code = editor.getValue();
    const regex = /(?:Image\.open|imread|io\.imread|open)\s*\(\s*["']([^"']*)["']/g;
    let newCode = code.replace(regex, (match) => {
        const func = match.split('(')[0];
        return `${func}("${fileName}"`;
    });
    if (newCode !== code) {
        editor.setValue(newCode);
    }
}

fileInput.addEventListener("change", async (e) => {
    const files = e.target.files;
    if (files.length === 0) return;
    if (Object.keys(fileStore).length === 0) fileListName.innerHTML = "";
    for (const file of files) {
        const fileName = file.name;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const data = new Uint8Array(ev.target.result);
            pyodideInstance.FS.writeFile(fileName, data);
            const blobUrl = URL.createObjectURL(new Blob([data], {type: file.type}));
            fileStore[fileName] = blobUrl;
            const fileItem = document.createElement("div");
            fileItem.className = "file-item";
            fileItem.innerHTML = `<span>${fileName}</span><i class="bi bi-chevron-right"></i>`;
            fileItem.onclick = () => {
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                fileItem.classList.add('active');
                inputImg.src = blobUrl;
                syncCode(fileName);
                logArea.innerText = `Input aktif: ${fileName}`;
                outputImg.src = "https://via.placeholder.com/500x300?text=Klik+Play+untuk+Proses+Baru";
            };
            fileListName.appendChild(fileItem);
            fileItem.click();
        };
        reader.readAsArrayBuffer(file);
    }
});

function clearFiles() {
    Object.keys(fileStore).forEach(f => {
        try { pyodideInstance.FS.unlink(f); } catch(e) {}
    });
    fileStore = {};
    fileListName.innerHTML = '<div class="text-center text-muted small py-4">Belum ada file diunggah</div>';
    inputImg.src = "https://via.placeholder.com/500x300?text=Pilih+File+di+Daftar";
    outputImg.src = "https://via.placeholder.com/500x300?text=Menunggu+Eksekusi";
    logArea.innerText = "Sistem dibersihkan.";
}

runBtn.addEventListener("click", async () => {
    const code = editor.getValue();
    logArea.innerText = "Memproses gambar...";
    try {
        const outputNames = ["output.png", "hasil.png", "result.png", "Hasil_grayscale.png", "output.jpg"];
        outputNames.forEach(name => {
            try { pyodideInstance.FS.unlink(name); } catch(e) {}
        });
        const beforeFiles = new Set(pyodideInstance.FS.readdir('.'));
        await pyodideInstance.runPythonAsync(code);
        const afterFiles = pyodideInstance.FS.readdir('.');
        let newFile = null;
        for (const f of afterFiles) {
            if (!beforeFiles.has(f) && /\.(png|jpg|jpeg|bmp)$/i.test(f)) {
                newFile = f;
                break;
            }
        }
        if (!newFile) {
            for (const name of outputNames) {
                if (pyodideInstance.FS.analyzePath(name).exists) {
                    newFile = name;
                    break;
                }
            }
        }
        if (newFile) {
            const data = pyodideInstance.FS.readFile(newFile);
            const blob = new Blob([data.buffer], { type: "image/png" });
            const url = URL.createObjectURL(blob);
            outputImg.src = url;
            const link = document.createElement("a");
            link.href = url;
            link.download = "hasil_" + newFile;
            link.click();
            logArea.innerText = `Berhasil! Output: ${newFile}`;
        } else {
            logArea.innerText = "Proses selesai, namun tidak ada file gambar output yang disimpan.";
        }
    } catch (err) {
        logArea.innerText = "Kesalahan Kode:\n" + err;
    }
});
</script>

{% endblock %}





{% comment %} FIXX {% endcomment %}

{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 6 - Praktikum{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<style>
.card-section {
    border: 1px solid rgba(16,32,58,0.08);
    border-radius: 12px;
    background: #fff;
    margin-bottom: 22px;
    box-shadow: 0 6px 18px rgba(16,32,58,0.03);
}

.card-section-header {
    padding: 14px 18px;
    font-size: 18px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 12px;
    background: #edf4fe;
    border-bottom: 1px solid rgba(16,32,58,0.06);
}

.card-section-body { padding: 20px; }

.editor-layout { display: flex; gap: 24px; margin-bottom: 20px; align-items: flex-start; }
.notebook-container { flex: 3; min-width: 0; display: flex; flex-direction: column; gap: 10px; }
.sidebar-container { flex: 1; min-width: 250px; position: sticky; top: 20px; display: flex; flex-direction: column; gap: 15px; }

.cell-container {
    border: 1px solid #e1e4e8;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
}

.cell-input-area {
    display: flex;
    background: #f8fafc;
    padding: 10px;
    gap: 10px;
}

.cell-info {
    font-family: monospace;
    font-size: 13px;
    color: #1d4ed8;
    min-width: 45px;
    padding-top: 8px;
}

.editor-wrapper { flex: 1; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; position: relative; }
.CodeMirror { height: auto; min-height: 40px; font-size: 14px; background: #282a36 !important; }

.cell-actions { display: flex; flex-direction: column; gap: 5px; }
.btn-action {
    width: 32px; height: 32px; border-radius: 6px; border: none;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; color: white; transition: 0.2s;
}
.btn-run { background: #22c55e; }
.btn-delete { background: #ef4444; }

.cell-output {
    padding: 10px 10px 10px 65px;
    border-top: 1px solid #f1f5f9;
    background: #fff;
}

.output-log {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #475569;
    margin-bottom: 8px;
}

.output-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    margin-top: 5px;
}

.btn-download-manual {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: #3b82f6;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 10px;
    transition: 0.2s;
}

.btn-download-manual:hover { background: #1d4ed8; color: white; }

.widget-box {
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 15px;
    background: #f8fafc;
}

.widget-title { font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
.file-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
.file-item {
    background: #fff; padding: 6px 10px; border-radius: 4px;
    font-size: 12px; margin-bottom: 4px; border: 1px solid #e2e8f0;
    cursor: pointer; display: flex; justify-content: space-between;
}
.file-item.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; font-weight: 600; }
.input-preview { width: 100%; height: 180px; object-fit: contain; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; }

.btn-add-cell-mid {
    height: 12px; background: transparent; margin: 2px 0;
    position: relative; cursor: pointer; display: flex;
    justify-content: center; align-items: center;
}
.btn-add-cell-mid:hover { background: #3b82f6; border-radius: 2px; }
.btn-add-cell-mid i { opacity: 0; color: white; font-size: 14px; transition: 0.2s; }
.btn-add-cell-mid:hover i { opacity: 1; }

#engine-status { font-size: 11px; color: #64748b; font-family: monospace; }
</style>

<h1 class="title-main mb-3">SUBBAB 6 – PRAKTIKUM</h1>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-journal-code"></i> Image Processing Notebook
    </div>
    <div class="card-section-body">
        <div class="editor-layout">
            <div class="notebook-container" id="notebook"></div>

            <div class="sidebar-container">
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-image"></i>Gambar</div>
                    <img id="input-display" class="input-preview" src="https://via.placeholder.com/300x200?text=Pilih+Gambar">
                </div>
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-files"></i> File Manager</div>
                    <label for="image-upload" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-upload"></i> Upload
                    </label>
                    <input type="file" id="image-upload" style="display: none;" accept="image/*" multiple>
                    <div id="file-list-names" class="file-list"></div>
                    <button class="btn btn-sm btn-link text-danger p-0" onclick="clearFiles()">Hapus Semua</button>
                </div>
                <div id="engine-status">Memuat Engine...</div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
let pyodideInstance;
let fileStore = {};
let notebookCells = [
    { id: 'c1', content: 'from PIL import Image\n\nimg = Image.open("pilih_gambar.jpg")\ngray = img.convert("L")\ngray.save("Hasil_grayscale.png")\ngray', output: null, log: null, fileName: "" },
    { id: 'c2', content: "binary = gray.point(lambda x: 255 if x > 128 else 0, '1')\nbinary.save(\"hasil_biner.png\")\nbinary", output: null, log: null, fileName: "" }
];
let editors = {};

async function initPyodide() {
    try {
        pyodideInstance = await loadPyodide();
        await pyodideInstance.loadPackage(["micropip"]);
        const micropip = pyodideInstance.pyimport("micropip");
        
        // Memuat Pillow DAN NumPy di awal agar mahasiswa bisa tambah cell sendiri tanpa error
        await micropip.install(["pillow", "numpy"]);
        
        await pyodideInstance.runPythonAsync(`
import io
import base64
from PIL import Image
import __main__

def get_image_as_base64(var_name):
    try:
        obj = getattr(__main__, var_name, None)
        if obj and isinstance(obj, Image.Image):
            buf = io.BytesIO()
            obj.save(buf, format='PNG')
            return base64.b64encode(buf.getvalue()).decode('utf-8')
    except:
        pass
    return None
        `);

        document.getElementById("engine-status").innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Engine Siap';
        renderNotebook();
    } catch (e) {
        document.getElementById("engine-status").innerText = "Error: " + e;
    }
}

function renderNotebook() {
    const container = document.getElementById("notebook");
    const scrollPos = window.scrollY;
    container.innerHTML = "";
    
    notebookCells.forEach((cell, index) => {
        const cellDiv = document.createElement("div");
        const hasOutput = cell.output || cell.log;
        
        cellDiv.innerHTML = `
            <div class="cell-container" id="cell-${cell.id}">
                <div class="cell-input-area">
                    <div class="cell-info">In [${index + 1}]</div>
                    <div class="editor-wrapper">
                        <textarea id="edit-ctrl-${cell.id}">${cell.content}</textarea>
                    </div>
                    <div class="cell-actions">
                        <button class="btn-action btn-run" onclick="runCell('${cell.id}')">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteCell('${cell.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="cell-output" id="out-${cell.id}" style="${hasOutput ? 'display: block;' : 'display: none;'}">
                    <div class="output-log" id="log-${cell.id}" style="${cell.log && !cell.log.includes('Error') ? 'color: #22c55e;' : 'color: #ef4444;'}">${cell.log || ''}</div>
                    <img class="output-image" id="img-${cell.id}" src="${cell.output || ''}" style="${cell.output ? 'display: block;' : 'display: none;'}">
                    <a id="dl-${cell.id}" class="btn-download-manual" href="${cell.output || ''}" download="${cell.fileName || 'hasil.png'}" style="${cell.output ? 'display: inline-flex;' : 'display: none;'}">
                        <i class="bi bi-download"></i> Unduh Gambar
                    </a>
                </div>
            </div>
            <div class="btn-add-cell-mid" onclick="addNewCellAt(${index + 1})">
                <i class="bi bi-plus-circle"></i>
            </div>
        `;
        container.appendChild(cellDiv);
        
        const editor = CodeMirror.fromTextArea(document.getElementById(`edit-ctrl-${cell.id}`), {
            mode: "python", theme: "dracula", lineNumbers: true, indentUnit: 4, viewportMargin: Infinity
        });
        
        editor.on("change", (cm) => {
            const cellObj = notebookCells.find(c => c.id === cell.id);
            if(cellObj) cellObj.content = cm.getValue();
        });
        editors[cell.id] = editor;
    });
    window.scrollTo(0, scrollPos);
}

function addNewCellAt(index) {
    const newId = 'c' + Date.now();
    notebookCells.splice(index, 0, { id: newId, content: "", output: null, log: null, fileName: "" });
    renderNotebook();
}

function deleteCell(id) {
    if (notebookCells.length === 1) return;
    notebookCells = notebookCells.filter(c => c.id !== id);
    delete editors[id];
    renderNotebook();
}

async function runCell(id) {
    const code = editors[id].getValue();
    const cellObj = notebookCells.find(c => c.id === id);
    const logLabel = document.getElementById(`log-${id}`);
    const imgElement = document.getElementById(`img-${id}`);
    const dlBtn = document.getElementById(`dl-${id}`);
    const outArea = document.getElementById(`out-${id}`);

    outArea.style.display = "block";
    logLabel.innerText = "Memproses...";
    logLabel.style.color = "#475569";
    imgElement.style.display = "none";
    dlBtn.style.display = "none";

    try {
        await pyodideInstance.runPythonAsync(code);
        
        const lines = code.trim().split('\n');
        const lastLine = lines[lines.length - 1].trim();

        let targetFileName = "hasil_praktikum.png";
        // Mencari pola .save("nama_file.png") di baris manapun dalam kode
        const saveMatch = code.match(/\.save\(\s*["']([^"']+)["']\s*\)/);
        if (saveMatch && saveMatch[1]) {
            targetFileName = saveMatch[1];
        }
        
        const base64Data = await pyodideInstance.runPythonAsync(`get_image_as_base64("${lastLine}")`);
        
        if (base64Data) {
            const url = `data:image/png;base64,${base64Data}`;
            cellObj.output = url;
            cellObj.log = "Berhasil diproses";
            cellObj.fileName = targetFileName;
            
            imgElement.src = url;
            imgElement.style.display = "block";
            logLabel.innerText = cellObj.log;
            logLabel.style.color = "#22c55e";

            dlBtn.href = url;
            dlBtn.download = targetFileName;
            dlBtn.style.display = "inline-flex";
        } else {
            cellObj.log = "Selesai dijalankan.";
            cellObj.output = null;
            logLabel.innerText = cellObj.log;
            logLabel.style.color = "#475569";
        }
    } catch (err) {
        logLabel.innerText = "Error:\n" + err;
        logLabel.style.color = "#ef4444";
        cellObj.log = logLabel.innerText;
        cellObj.output = null;
    }
}

document.getElementById("image-upload").addEventListener("change", (e) => {
    const files = e.target.files;
    const list = document.getElementById("file-list-names");
    for (const file of files) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            pyodideInstance.FS.writeFile(file.name, data);
            const url = URL.createObjectURL(new Blob([data], {type: file.type}));
            fileStore[file.name] = url;
            const item = document.createElement("div");
            item.className = "file-item";
            item.innerHTML = `<span>${file.name}</span><i class="bi bi-check2 text-success"></i>`;
            item.onclick = () => {
                document.querySelectorAll(".file-item").forEach(el => el.classList.remove("active"));
                item.classList.add("active");
                document.getElementById("input-display").src = url;
                if (notebookCells.length > 0) {
                    let first = editors[notebookCells[0].id].getValue();
                    const updated = first.replace(/Image\.open\s*\(\s*["']([^"']*)["']\s*\)/g, `Image.open("${file.name}")`);
                    editors[notebookCells[0].id].setValue(updated);
                }
            };
            list.appendChild(item);
            item.click();
        };
        reader.readAsArrayBuffer(file);
    }
});

function clearFiles() {
    Object.keys(fileStore).forEach(f => {
        try { pyodideInstance.FS.unlink(f); } catch(e) {}
        URL.revokeObjectURL(fileStore[f]);
    });
    fileStore = {};
    document.getElementById("file-list-names").innerHTML = "";
    document.getElementById("input-display").src = "https://via.placeholder.com/300x200?text=Pilih+Gambar";
}

initPyodide();
</script>
{% endblock %}





{% comment %} FULL FIX {% endcomment %}

{% extends "mhs/base.html" %}
{% load static %}

{% block title %}Subbab 6 - Praktikum{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<style>
/* ================= CSS MATERI ================= */
.card-section {
    border: 1px solid rgba(16,32,58,0.08);
    border-radius: 12px;
    background: #fff;
    margin-bottom: 22px;
    box-shadow: 0 6px 18px rgba(16,32,58,0.03);
}

.card-section-header {
    padding: 14px 18px;
    font-size: 18px;
    font-weight: 800;
    display:flex;
    align-items:center;
    gap:12px;
    background: #edf4fe;
    border-bottom: 1px solid rgba(16,32,58,0.06);
}

.card-section-header i {
    font-size:20px;
    color:var(--primary-500);
    width:36px;height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:8px;
    background: rgba(59,123,227,0.12);
}

.card-section-body {
    padding: 20px;
    font-size: 16px;
    color: #222;
    line-height: 1.7;
}

.step-title { font-size:12pt; font-weight:700; margin:24px 0 10px; }

.code-box-import {
    background:#eaf3ff;
    border:2px dashed #b7cff5;
    border-radius:20px;
    padding:18px 26px;
    max-width:520px;
    margin:26px auto;
    font-family:"Courier New", monospace;
    font-size:20px;
    text-align:center;
    line-height:1.6;
}

.code-box-code {
    background:#f8fbff;
    border:2px solid #3b82f6;
    border-radius:14px;
    padding:14px 22px;
    max-width:700px;
    margin:14px auto 26px;
    font-family:"Courier New", monospace;
    font-size:16px;
    line-height:1.6;
}

.keyword{color:#c026d3;font-weight:600;}
.module{color:#0f766e;}
.string{color:#b91c1c;}

/* ================= CSS EDITOR NOTEBOOK ================= */
.editor-layout { display: flex; gap: 24px; margin-bottom: 20px; align-items: flex-start; }
.notebook-container { flex: 3; min-width: 0; display: flex; flex-direction: column; gap: 10px; }
.sidebar-container { flex: 1; min-width: 250px; position: sticky; top: 20px; display: flex; flex-direction: column; gap: 15px; }

.cell-container { border: 1px solid #e1e4e8; border-radius: 8px; background: #fff; overflow: hidden; }
.cell-input-area { display: flex; background: #f8fafc; padding: 10px; gap: 10px; }
.cell-info { font-family: monospace; font-size: 13px; color: #1d4ed8; min-width: 45px; padding-top: 8px; }
.editor-wrapper { flex: 1; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; position: relative; }
.CodeMirror { height: auto; min-height: 40px; font-size: 14px; background: #282a36 !important; }

.cell-actions { display: flex; flex-direction: column; gap: 5px; }
.btn-action {
    width: 32px; height: 32px; border-radius: 6px; border: none;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; color: white; transition: 0.2s;
}
.btn-run { background: #22c55e; }
.btn-delete { background: #ef4444; }

.cell-output { padding: 10px 10px 10px 65px; border-top: 1px solid #f1f5f9; background: #fff; }
.output-log { font-family: 'Courier New', monospace; font-size: 12px; color: #475569; margin-bottom: 8px; }
.output-image { max-width: 100%; max-height: 400px; border-radius: 4px; border: 1px solid #e2e8f0; margin-top: 5px; }

.btn-download-manual {
    display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
    background: #3b82f6; color: white; text-decoration: none; border-radius: 6px;
    font-size: 12px; font-weight: 600; margin-top: 10px; transition: 0.2s;
}

.widget-box { border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; background: #f8fafc; }
.widget-title { font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
.file-list { max-height: 150px; overflow-y: auto; margin: 10px 0; }
.file-item {
    background: #fff; padding: 6px 10px; border-radius: 4px; font-size: 12px; 
    margin-bottom: 4px; border: 1px solid #e2e8f0; cursor: pointer; display: flex; justify-content: space-between;
}
.file-item.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; font-weight: 600; }
.input-preview { width: 100%; height: 180px; object-fit: contain; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; }

.btn-add-cell-mid {
    height: 12px; background: transparent; margin: 2px 0;
    position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center;
}
.btn-add-cell-mid:hover { background: #3b82f6; border-radius: 2px; }
.btn-add-cell-mid i { opacity: 0; color: white; font-size: 14px; transition: 0.2s; }
.btn-add-cell-mid:hover i { opacity: 1; }

#engine-status { font-size: 11px; color: #64748b; font-family: monospace; }

/* ================= NAVIGASI (KANAN) ================= */
.nav-container {
    display: flex;
    justify-content: flex-end; /* Tombol ke kanan */
    gap: 10px;
    margin: 20px 0;
}
</style>

<h1 class="title-main mb-3">
    SUBBAB 6 – <span style="color:var(--primary-500)">PRAKTIKUM</span>
</h1>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-journal-bookmark"></i> Tujuan Pembelajaran
    </div>
    <div class="card-section-body">
        <ul>
            <li>Memahami konsep citra digital.</li>
            <li>Mengubah citra RGB menjadi grayscale.</li>
            <li>Mengubah citra grayscale menjadi biner.</li>
        </ul>
    </div>
</section>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-lightbulb"></i> Citra <em>grayscale</em> dan citra biner
    </div>
    <div class="card-section-body">
        <p style="text-align:justify;text-indent:30px;">
            Pengolahan citra digital adalah proses mengolah dan memperbaiki gambar menggunakan komputer agar 
            tampilannya lebih jelas atau sesuai kebutuhan. Salah satu bahasa pemrograman yang banyak digunakan 
            dalam pengolahan citra adalah Python...
        </p>

        <div class="code-box-import">
            <span class="keyword">from</span> <span class="module">PIL</span> <span class="keyword">import</span> <span class="module">Image</span><br>
            <span class="keyword">from</span> <span class="module">PIL</span> <span class="keyword">import</span> <span class="module">ImageFilter</span>
        </div>

        <div class="step-title">1) Mengubah gambar berwarna (RGB) menjadi gambar <em>grayscale</em></div>
        <div class="code-box-code">
            img = Image.open(<span class="string">"gambar.jpg"</span>)<br>
            gray = img.convert(<span class="string">"L"</span>)
        </div>

        <div class="step-title">2) Mengubah gambar <em>grayscale</em> menjadi gambar <em>biner</em></div>
        <div class="code-box-code">
            img = Image.open(<span class="string">"gambar.jpg"</span>).convert(<span class="string">"L"</span>)<br>
            threshold = int(sum(img.getdata()) / len(img.getdata()))<br>
            binary_img = img.point(<span class="keyword">lambda</span> x: 255 <span class="keyword">if</span> x &gt; threshold <span class="keyword">else</span> 0)
        </div>
    </div>
</section>

<section class="card-section">
    <div class="card-section-header">
        <i class="bi bi-journal-code"></i> Image Processing Notebook
    </div>
    
    <div class="card-section-body">
        <div class="editor-layout">
            <div class="notebook-container" id="notebook"></div>
            <div class="sidebar-container">
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-image"></i> Gambar</div>
                    <img id="input-display" class="input-preview" src="https://via.placeholder.com/300x200?text=Pilih+Gambar">
                </div>
                <div class="widget-box">
                    <div class="widget-title"><i class="bi bi-files"></i> File Manager</div>
                    <label for="image-upload" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-upload"></i> Upload
                    </label>
                    <input type="file" id="image-upload" style="display: none;" accept="image/*" multiple>
                    <div id="file-list-names" class="file-list"></div>
                    <button class="btn btn-sm btn-link text-danger p-0" onclick="clearFiles()">Hapus Semua</button>
                </div>
                <div id="engine-status">Memuat Engine...</div>
            </div>
        </div>
    </div>
</section>

<div class="nav-container">
    <a href="{% url 'pengertian_citra' %}" class="btn btn-outline-secondary">
        <i class="bi bi-chevron-left"></i> Sebelumnya
    </a>
    <a href="{% url 'jenis_citra' %}" class="btn btn-primary">
        Selanjutnya <i class="bi bi-chevron-right"></i>
    </a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
let pyodideInstance;
let fileStore = {};
let notebookCells = [
    { id: 'c1', content: 'from PIL import Image\n\nimg = Image.open("pilih_gambar.jpg")\ngray = img.convert("L")\ngray.save("Hasil_grayscale.png")\ngray', output: null, log: null, fileName: "" },
    { id: 'c2', content: "binary = gray.point(lambda x: 255 if x > 128 else 0, '1')\nbinary.save(\"hasil_biner.png\")\nbinary", output: null, log: null, fileName: "" }
];
let editors = {};

async function initPyodide() {
    try {
        pyodideInstance = await loadPyodide();
        await pyodideInstance.loadPackage(["micropip"]);
        const micropip = pyodideInstance.pyimport("micropip");
        await micropip.install(["pillow", "numpy"]);
        
        await pyodideInstance.runPythonAsync(`
import io, base64
from PIL import Image
import __main__
def get_image_as_base64(var_name):
    try:
        obj = getattr(__main__, var_name, None)
        if obj and isinstance(obj, Image.Image):
            buf = io.BytesIO()
            obj.save(buf, format='PNG')
            return base64.b64encode(buf.getvalue()).decode('utf-8')
    except: pass
    return None
        `);
        document.getElementById("engine-status").innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Engine Siap';
        renderNotebook();
    } catch (e) {
        document.getElementById("engine-status").innerText = "Error: " + e;
    }
}

function renderNotebook() {
    const container = document.getElementById("notebook");
    const scrollPos = window.scrollY;
    container.innerHTML = "";
    notebookCells.forEach((cell, index) => {
        const cellDiv = document.createElement("div");
        const hasOutput = cell.output || cell.log;
        cellDiv.innerHTML = `
            <div class="cell-container" id="cell-${cell.id}">
                <div class="cell-input-area">
                    <div class="cell-info">In [${index + 1}]</div>
                    <div class="editor-wrapper"><textarea id="edit-ctrl-${cell.id}">${cell.content}</textarea></div>
                    <div class="cell-actions">
                        <button class="btn-action btn-run" onclick="runCell('${cell.id}')"><i class="bi bi-play-fill"></i></button>
                        <button class="btn-action btn-delete" onclick="deleteCell('${cell.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="cell-output" id="out-${cell.id}" style="${hasOutput ? 'display: block;' : 'display: none;'}">
                    <div class="output-log" id="log-${cell.id}" style="${cell.log && !cell.log.includes('Error') ? 'color: #22c55e;' : 'color: #ef4444;'}">${cell.log || ''}</div>
                    <img class="output-image" id="img-${cell.id}" src="${cell.output || ''}" style="${cell.output ? 'display: block;' : 'display: none;'}">
                    <a id="dl-${cell.id}" class="btn-download-manual" href="${cell.output || ''}" download="${cell.fileName || 'hasil.png'}" style="${cell.output ? 'display: inline-flex;' : 'display: none;'}"><i class="bi bi-download"></i> Unduh Gambar</a>
                </div>
            </div>
            <div class="btn-add-cell-mid" onclick="addNewCellAt(${index + 1})"><i class="bi bi-plus-circle"></i></div>
        `;
        container.appendChild(cellDiv);
        const editor = CodeMirror.fromTextArea(document.getElementById(`edit-ctrl-${cell.id}`), {
            mode: "python", theme: "dracula", lineNumbers: true, indentUnit: 4, viewportMargin: Infinity
        });
        editor.on("change", (cm) => {
            const cellObj = notebookCells.find(c => c.id === cell.id);
            if(cellObj) cellObj.content = cm.getValue();
        });
        editors[cell.id] = editor;
    });
    window.scrollTo(0, scrollPos);
}

function addNewCellAt(index) {
    const newId = 'c' + Date.now();
    notebookCells.splice(index, 0, { id: newId, content: "", output: null, log: null, fileName: "" });
    renderNotebook();
}

function deleteCell(id) {
    if (notebookCells.length === 1) return;
    notebookCells = notebookCells.filter(c => c.id !== id);
    delete editors[id];
    renderNotebook();
}

async function runCell(id) {
    const code = editors[id].getValue();
    const cellObj = notebookCells.find(c => c.id === id);
    const logLabel = document.getElementById(`log-${id}`);
    const imgElement = document.getElementById(`img-${id}`);
    const dlBtn = document.getElementById(`dl-${id}`);
    const outArea = document.getElementById(`out-${id}`);

    outArea.style.display = "block";
    logLabel.innerText = "Memproses...";
    try {
        await pyodideInstance.runPythonAsync(code);
        const lines = code.trim().split('\n');
        const lastLine = lines[lines.length - 1].trim();
        let targetFileName = "hasil_praktikum.png";
        const saveMatch = code.match(/\.save\(\s*["']([^"']+)["']\s*\)/);
        if (saveMatch) targetFileName = saveMatch[1];
        
        const base64Data = await pyodideInstance.runPythonAsync(`get_image_as_base64("${lastLine}")`);
        if (base64Data) {
            const url = `data:image/png;base64,${base64Data}`;
            cellObj.output = url;
            cellObj.log = "Berhasil diproses";
            cellObj.fileName = targetFileName;
            imgElement.src = url;
            imgElement.style.display = "block";
            dlBtn.href = url;
            dlBtn.download = targetFileName;
            dlBtn.style.display = "inline-flex";
        } else {
            cellObj.log = "Selesai dijalankan.";
            imgElement.style.display = "none";
        }
        logLabel.innerText = cellObj.log;
        logLabel.style.color = "#22c55e";
    } catch (err) {
        logLabel.innerText = "Error:\n" + err;
        logLabel.style.color = "#ef4444";
    }
}

document.getElementById("image-upload").addEventListener("change", (e) => {
    const files = e.target.files;
    const list = document.getElementById("file-list-names");
    for (const file of files) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            pyodideInstance.FS.writeFile(file.name, data);
            const url = URL.createObjectURL(new Blob([data], {type: file.type}));
            fileStore[file.name] = url;
            const item = document.createElement("div");
            item.className = "file-item";
            item.innerHTML = `<span>${file.name}</span><i class="bi bi-check2 text-success"></i>`;
            item.onclick = () => {
                document.querySelectorAll(".file-item").forEach(el => el.classList.remove("active"));
                item.classList.add("active");
                document.getElementById("input-display").src = url;
                if (notebookCells.length > 0) {
                    let first = editors[notebookCells[0].id].getValue();
                    const updated = first.replace(/Image\.open\s*\(\s*["']([^"']*)["']\s*\)/g, `Image.open("${file.name}")`);
                    editors[notebookCells[0].id].setValue(updated);
                }
            };
            list.appendChild(item);
            item.click();
        };
        reader.readAsArrayBuffer(file);
    }
});

function clearFiles() {
    Object.keys(fileStore).forEach(f => {
        try { pyodideInstance.FS.unlink(f); } catch(e) {}
        URL.revokeObjectURL(fileStore[f]);
    });
    fileStore = {};
    document.getElementById("file-list-names").innerHTML = "";
    document.getElementById("input-display").src = "https://via.placeholder.com/300x200?text=Pilih+Gambar";
}

initPyodide();
</script>

{% endblock %}
